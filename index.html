<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lista de Sa√≠das</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <script>
    (function() {
      document.documentElement.classList.add("dark");
      document.documentElement.style.opacity = "0";
    })();
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class', // Ainda necess√°rio para o Tailwind funcionar
      theme: {
        extend: {
          fontFamily: { inter: ['Inter', 'system-ui', 'ui-sans-serif']},
          colors: {
            brand: {
              DEFAULT: '#2563eb',
              dark: '#1d4ed8'
            }
          },
          boxShadow: {
            soft: '0 10px 25px -10px rgba(0,0,0,.25)'
          }
        }
      }
    }
  </script>


  <style>
    :root{
      --border:rgba(148,163,184,.35);
      --bg-primary: #fff;
      --bg-secondary: #f8fafc;
      --bg-card: #fff;
    }
    .dark {
      --border:rgba(148,163,184,.25);
      --bg-primary: #0b1220;
      --bg-secondary: #131b2b;
      --bg-card: #0b1220;
    }

    *{outline:0}
    .input{border:1px solid var(--border);border-radius:12px;padding:.65rem .8rem;background:var(--bg-primary);color:var(--text-primary);transition:all .2s}
    .dark .input{background:#0b1220;color:#f8fafc;border-color:rgba(148,163,184,.25)}
    .input:focus{box-shadow:0 0 0 3px rgba(37,99,235,.2);border-color:#2563eb}
    .btn-primary{background:#2563eb;color:#fff;border-radius:12px;padding:.65rem .95rem;font-weight:800;transition:transform .05s ease;box-shadow:0 10px 25px -10px rgba(37,99,235,.6)}
    .btn-primary:hover{background:#1d4ed8}
    .btn-primary:active{transform:translateY(1px)}
    .btn-secondary{background:#e2e8f0;border:1px solid var(--border);border-radius:12px;padding:.6rem .9rem;font-weight:700}
    .dark .btn-secondary{background:#0b1220}
    .btn-danger{background:#ef4444;color:#fff;border-radius:12px;padding:.6rem .9rem;font-weight:800}
    .btn-ghost{border:1px solid var(--border);border-radius:12px;padding:.5rem .8rem;font-weight:700;background:transparent}
    .btn-icon{border:1px solid var(--border);border-radius:12px;padding: .5rem; font-weight:700;background:transparent;line-height:1; min-width: 38px; text-align: center;}
    .btn-icon:hover, .btn-ghost:hover { background-color: rgba(148,163,184,.1); }
    .dark .btn-icon:hover, .dark .btn-ghost:hover { background-color: rgba(148,163,184,.2); }
    
    .card{border:1px solid var(--border);background:var(--bg-card);border-radius:16px;padding:1rem 1rem 1.25rem 1rem;box-shadow:0 10px 25px -12px rgba(0,0,0,.25)}
    .dark .card{background:#0b1220}
    
    .card-chat {
      padding: 0;
      height: 70vh; 
      display: flex;
      overflow: hidden;
    }
    
    .section-title{font-weight:800}
    .badge{background:#fde68a;color:#78350f;border-radius:9999px;padding:.1rem .55rem;font-size:.75rem;font-weight:800}
    .field>label{display:block;font-size:.85rem;opacity:.8;margin-bottom:.25rem}
    .tab-btn{border:1px solid var(--border);border-radius:10px;padding:.55rem .7rem;text-align:left;font-weight:800;background:transparent; display: flex; align-items: center; position: relative; /* Para o badge */}
    .tab-btn.active{background:#2563eb;color:#fff;border-color:#2563eb}
    
    .notification-badge {
      position: absolute;
      top: 6px;
      right: 8px;
      background-color: #ef4444;
      color: white;
      font-size: 10px;
      font-weight: 800;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #2563eb; /* Cor de fundo do bot√£o ativo */
    }
    
    #toast{background:#111827;color:#fff;border-radius:9999px;padding:.6rem 1rem;font-weight:800;box-shadow:0 10px 25px -12px rgba(0,0,0,.35)}
    
    .pending-item, .approved-item { cursor: grab; }
    .pending-item:active, .approved-item:active { cursor: grabbing; }
    .dragging { opacity: 0.5; }
    .drag-over-top { border-top: 2px dashed #2563eb !important; }
    .drag-over-bottom { border-bottom: 2px dashed #2563eb !important; }

    .pending-item{border-left:4px solid #f59e0b;background:#fffbeb;border-radius:12px;padding:.7rem .75rem;display:flex;align-items:center;justify-content:space-between;gap:.75rem}
    .approved-item{border-left:4px solid #22c55e;background:#ecfdf5;border-radius:12px;padding:.7rem .75rem;display:flex;align-items:center;justify-content:space-between;gap:.75rem}
    .dark .pending-item{background:#0f172a}
    .dark .approved-item{background:#052e1a}
    .hidden{display:none}
    #modal-overlay.flex { display: flex; }

    /* Estilos de Alarme */
    @keyframes pulse-red {
      0%, 100% { background-color: #ef4444; color: white; }
      50% { background-color: #f87171; color: white; }
    }
    .alarm-level-1 { background-color: #fef3c7; } /* Amarelo claro */
    .dark .alarm-level-1 { background-color: #422006; }
    .alarm-level-2 { background-color: #fde68a; } /* Amarelo mais forte */
    .dark .alarm-level-2 { background-color: #78350f; }
    .alarm-level-3 { background-color: #fca5a5; } /* Vermelho claro */
    .dark .alarm-level-3 { background-color: #7f1d1d; }
    .alarm-level-4 { 
      animation: pulse-red 1.5s infinite; 
      border-color: #b91c1c;
    }
    .dark .alarm-level-4 { 
      animation: pulse-red 1.5s infinite; 
      border-color: #ef4444;
    }

    /* Estilos de Chat */
    .chat-container {
      display: flex;
      width: 100%;
      height: 100%;
    }
    .chat-sidebar {
      width: 280px;
      border-right: 1px solid var(--border);
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
    }
    .chat-sidebar-header {
      padding: 0.75rem;
      font-weight: 800;
      border-bottom: 1px solid var(--border);
    }
    .chat-contact-list {
      flex-grow: 1;
      overflow-y: auto;
    }
    .chat-contact {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
    }
    .chat-contact:hover {
      background: rgba(148,163,184,.1);
    }
    .chat-contact.active {
      background: var(--bg-primary);
      font-weight: 800;
      color: #2563eb;
    }
    
    .chat-main {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
    }
    .chat-main-header {
      padding: 0.75rem 1rem;
      font-weight: 800;
      border-bottom: 1px solid var(--border);
      background: var(--bg-secondary);
    }
    
    .chat-box {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .chat-input-area {
      border-top: 1px solid var(--border);
      padding: 0.5rem;
      display: flex;
      gap: 0.5rem;
      background: var(--bg-secondary);
    }
    
    .chat-msg { position: relative; display: flex; flex-direction: column; }
    .chat-msg.sent { align-items: flex-end; }
    .chat-msg.received { align-items: flex-start; }
    
    .chat-msg-bubble { 
      max-w-xs; padding: .5rem .75rem; border-radius: 12px; 
      word-wrap: break-word; font-size: 0.9rem;
    }
    .chat-msg.sent .chat-msg-bubble { background: #2563eb; color: white; border-bottom-right-radius: 4px; }
    .chat-msg.received .chat-msg-bubble { background: #e2e8f0; border: 1px solid var(--border); border-bottom-left-radius: 4px; }
    .dark .chat-msg.received .chat-msg-bubble { background: #1e293b; color: #f8fafc; border-color: var(--border); }
    
    .chat-msg-user { font-size: .75rem; font-weight: 800; opacity: .7; margin: 0 .25rem .1rem .25rem; }
    
    .chat-msg-time { 
      font-size: .65rem; font-weight: 700; opacity: .6; 
      margin: 0.1rem .25rem 0 .25rem;
    }
    .chat-msg.sent .chat-msg-time { text-align: right; }
    .chat-msg.received .chat-msg-time { text-align: left; }

    .chat-msg-actions {
      position: absolute;
      top: 0;
      display: none;
      gap: 4px;
      z-index: 10;
    }
    .chat-msg.sent .chat-msg-actions { right: 0; }
    .chat-msg.received .chat-msg-actions { left: 0; }
    .chat-msg:hover .chat-msg-actions { display: flex; }
    .chat-msg-actions button {
      padding: 2px 4px !important;
      font-size: 10px !important;
      line-height: 1 !important;
      min-width: 20px !important;
      border-radius: 6px !important;
      background-color: rgba(0,0,0,0.2);
    }
    .dark .chat-msg-actions button { background-color: rgba(255,255,255,0.2); }
    
    .presence-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
      display: inline-block;
      flex-shrink: 0; 
    }
    .online-dot {
      background-color: #22c55e;
      border: 1px solid rgba(255,255,255,0.5);
      box-shadow: 0 0 5px #22c55e;
    }
    .offline-dot {
      background-color: #94a3b8;
      border: 1px solid rgba(0,0,0,0.1);
    }
    .chat-contact-details {
      display: flex;
      align-items: center;
      min-width: 0; 
    }
    .chat-contact-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>

</head>
<body class="font-inter bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-100 transition-colors duration-300">

  <div id="login-overlay" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white dark:bg-slate-800 shadow-soft p-6">
      <div class="flex items-center gap-3 mb-4">
        <h2 class="text-xl font-extrabold">Acesso</h2>
      </div>
      <p class="text-sm opacity-80 mb-4">Entre com usu√°rio e PIN.</p>
      <div class="grid gap-3">
        <input id="login-user" class="input" placeholder="Usu√°rio">
        <input id="login-pin" class="input" placeholder="PIN" type="password" inputmode="numeric">
        <button id="login-btn" class="btn-primary">Entrar</button>
      </div>
      <p id="login-msg" class="mt-3 text-sm text-red-500 hidden"></p>
    </div>
  </div>

  <div id="modal-overlay" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white dark:bg-slate-800 shadow-soft p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 id="modal-title" class="text-xl font-extrabold">Editar</h2>
        <button id="modal-close" class="btn-icon">‚úñ</button>
      </div>
      <div id="modal-content" class="grid gap-3">
        </div>
      <div class="mt-4 flex gap-2">
        <button id="modal-save" class="btn-primary flex-1">Salvar</button>
        <button id="modal-cancel" class="btn-secondary flex-1">Cancelar</button>
      </div>
    </div>
  </div>


  <div id="app" class="opacity-0">
    <header class="sticky top-0 z-40 backdrop-blur bg-white/70 dark:bg-slate-900/70 border-b border-slate-200/60 dark:border-slate-700/60">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <h1 class="text-lg sm:text-2xl font-black">Lista de Sa√≠das<span class="text-slate-400"></span></h1>
        </div>
        <div class="flex items-center gap-2">
          <span id="clock" class="hidden sm:inline font-mono text-sm opacity-80"></span>
          <button id="logout-btn" class="btn-ghost">Sair</button>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-6 grid md:grid-cols-[280px,1fr] gap-6">
      <aside class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-4 space-y-4 h-fit md:sticky md:top-20">
        <h3 class="text-base font-extrabold">Navega√ß√£o</h3>
        <nav class="grid gap-2">
          <button class="tab-btn active" data-tab="saidas">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
            Controle de Sa√≠das
          </button>
          
          <button class="tab-btn" data-tab="chat">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" /></svg>
            Chat
            <span id="chat-notification-badge" class="notification-badge hidden">0</span> 
          </button>
          
          <button class="tab-btn" data-tab="s5">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13z" clip-rule="evenodd" /></svg>
            Gest√£o 5S
          </button>
          <button class="tab-btn" data-tab="config">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.835 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.835 2.942-.734 2.106-2.106a1.533 1.533 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.835-1.372-.734-2.942-2.106-2.106A1.532 1.532 0 0111.49 3.17zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
            Configura√ß√µes
          </button>
        </nav>

        <div class="rounded-xl bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300 p-3 text-sm">
          <b>Status:</b> <span id="status-conn">Conectado</span> <span class="opacity-70">(Nuvem)</span>
        </div>

        <div>
          <button id="ddm-header" class="w-full flex items-center justify-between rounded-xl bg-slate-50 dark:bg-slate-700/40 px-3 py-2 text-sm font-bold">
            Gerenciar Dados <span class="transition-transform" id="ddm-caret">‚ñº</span>
          </button>
          <div id="ddm" class="mt-3 grid gap-2 hidden"> <button id="btn-backup-download" class="btn-secondary">Baixar Backup Completo (.json)</button>
            <label class="btn-secondary cursor-pointer text-center">
              <input id="file-backup" type="file" accept="application/json" class="hidden">
              Carregar Backup Completo (.json)
            </label>
            <button id="btn-reset" class="btn-danger">Resetar TUDO (Nuvem)</button>
          </div>
        </div>
      </aside>

      <section class="space-y-6">
        <div id="tab-saidas" class="card">
          <div class="flex items-center justify-between gap-4">
            <div>
              <h2 class="text-xl font-bold">Painel de Controle</h2>
              <p class="text-sm opacity-70">Hor√°rio de Bras√≠lia</p>
            </div>
            <div id="alarm-pill" class="px-3 py-1 rounded-full text-xs font-black bg-emerald-200 text-emerald-800 dark:bg-emerald-800 dark:text-emerald-200 cursor-pointer transition-colors" title="Clique para ligar/desligar o alarme sonoro">ALARME: LIGADO</div>
          </div>

          <div class="mt-6">
            <h3 class="section-title">Adicionar Aluno √† Fila de Espera</h3>
            <div class="flex gap-2">
              <input id="input-name" class="input flex-1" placeholder="Nome completo do aluno (ex: Allanna Leite Teixeira)">
              <button id="btn-add" class="btn-primary">Adicionar √† Fila</button>
            </div>
          </div>

          <div class="mt-8">
            <div class="flex items-center justify-between">
              <h3 class="section-title">Fila de Sa√≠da & Retorno <span id="pending-count" class="badge">0</span></h3>
              <input id="hist-search" class="input w-56" placeholder="üîé Filtrar hist√≥rico...">
            </div>
            <ul id="pending-list" class="mt-3 grid gap-3"></ul>
          </div>

          <div class="mt-8">
            <h3 class="section-title">Hist√≥rico</h3>
            <div id="history" class="mt-3 grid gap-2"></div>
          </div>
        </div>

        <div id="tab-chat" class="card card-chat hidden">
          <div class="chat-container">
            <aside class="chat-sidebar">
              <div class="chat-sidebar-header">Contatos</div>
              <nav id="chat-contact-list" class="chat-contact-list">
                <p class="p-4 text-sm opacity-70">Carregando...</p>
              </nav>
            </aside>
            
            <main class="chat-main">
              <header id="chat-main-header" class="chat-main-header">
                Selecione um contato para conversar
              </header>
              <div id="chat-box" class="chat-box">
              </div>
              <div id="chat-input-area" class="chat-input-area hidden">
                <input id="chat-input" class="input flex-1" placeholder="Digite sua mensagem...">
                <button id="chat-send" class="btn-primary px-5">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009.175 17V4.609a1 1 0 00-1.447-.894l-5 1.428zM10.894 2.553l7 14a1 1 0 001.169-1.409l-5-1.429A1 1 0 0013.825 17V4.609a1 1 0 00-1.447-.894l5 1.428z" /></svg>
                </button>
              </div>
            </main>
          </div>
        </div>

        <div id="tab-s5" class="card hidden">
          <h2 class="text-xl font-bold mb-4 text-center">Gest√£o de Qualidade 5S</h2>
          <div class="grid sm:grid-cols-2 gap-3">
            <input id="s5-p1" class="input" placeholder="Pessoa 1">
            <input id="s5-p2" class="input" placeholder="Pessoa 2">
            <input id="s5-p3" class="input" placeholder="Pessoa 3">
            <input id="s5-p4" class="input" placeholder="Pessoa 4">
            <select id="s5-shift" class="input"><option>Manh√£</option><option>Tarde</option><option>Noite</option></select>
            <button id="s5-add" class="btn-primary sm:col-span-2">Adicionar Equipe</button>
          </div>
          <ul id="s5-list" class="mt-6 grid gap-2"></ul>
        </div>

        <div id="tab-config" class="card hidden">
          <h2 class="text-xl font-bold mb-4 text-center">Configura√ß√µes</h2>
          <div class="grid sm:grid-cols-2 gap-4">
            <div class="field">
              <label>1¬∫ Alerta (min)</label><input id="al1" type="number" class="input" min="1">
            </div>
            <div class="field">
              <label>2¬∫ Alerta (min)</label><input id="al2" type="number" class="input" min="1">
            </div>
            <div class="field">
              <label>3¬∫ Alerta (min)</label><input id="al3" type="number" class="input" min="1">
            </div>
            <div class="field">
              <label>4¬∫ Alerta (min)</label><input id="al4" type="number" class="input" min="1">
            </div>
            <div class="field sm:col-span-2">
              <label>Alarme Cont√≠nuo (min)</label><input id="alP" type="number" class="input" min="1">
            </div>
            <div class="field sm:col-span-2">
              <label>Motivo Padr√£o</label><input id="def-reason" class="input">
            </div>
            <button id="btn-save-settings" class="btn-primary sm:col-span-2">Salvar Configura√ß√µes</button>
          </div>
        </div>
      </section>
    </main>

    <div id="toast" class="fixed bottom-4 right-4 hidden"></div>

    </div>

  <script>
    // Reveal after JS initialization starts
    window.addEventListener('load', () => {
      document.documentElement.style.opacity = "1";
      document.getElementById('app').classList.remove('opacity-0');
    });
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, push, update, remove, off, onDisconnect } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    /* ========================== Firebase init ========================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBl8K0WVSDtGsgJygr3yCSsQ_voywnm114",
      authDomain: "gerenciador-saidas-5s-e4c58.firebaseapp.com",
      databaseURL: "https://gerenciador-saidas-5s-e4c58-default-rtdb.firebaseio.com",
      projectId: "gerenciador-saidas-5s-e4c58",
      storageBucket: "gerenciador-saidas-5s-e4c58.firebasestorage.app",
      messagingSenderId: "990056306037",
      appId: "1:990056306037:web:7bb1f8b8247631acb3af3c",
      measurementId: "G-0ZFEQRYPQT"
    };

    let app, db;
    app = initializeApp(firebaseConfig);
    db = getDatabase(app);
    
    /* ========================== State ========================== */
    const state = {
      session: null,
      settings: {
        alertLevels: [6,10,15,20],
        persistentAlarmMinutes: 25,
        defaultReason: "Banheiro"
      },
      requests: [],
      s5Teams: [],
      
      users: {}, 
      selectedChatUser: null,
      currentMessages: [], 
      messageListener: null,
      lastMessageTimestamp: 0,
      globalMessageListeners: [], 
      unreadChats: new Set(),
      
      audioInitialized: false, 
      audioCtx: null, 
      alarmOn: true, 
      alarmingStudents: new Set(),
      alarmLevelsCache: {},
      timers: { clock:null, alert:null },
      editingItemId: null,
    };

    /* ========================== Utils ========================== */
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => [...document.querySelectorAll(sel)];
    const fmtDur = (ms)=>{
      if (isNaN(ms) || ms < 0) return "0m 0s";
      const s = Math.floor(ms/1000);
      return `${Math.floor(s/60)}m ${s%60}s`;
    };
    const cleanName = (n)=> (n||"").trim().toLowerCase().split(" ").filter(Boolean).map(w=>w[0].toUpperCase()+w.slice(1)).join(" ");
    
    const formatDateTimeLocal = (isoString) => {
      if (!isoString) return '';
      const date = new Date(isoString);
      date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
      return date.toISOString().slice(0, 16);
    };

    const parseDateTimeLocal = (dateTimeLocalString) => {
        if (!dateTimeLocalString) return '';
        const date = new Date(dateTimeLocalString);
        return date.toISOString();
    };

    const formatChatTime = (isoString) => {
        if (!isoString) return '';
        try {
            return new Date(isoString).toLocaleTimeString("pt-BR", { hour: '2-digit', minute: '2-digit' });
        } catch (e) { return ''; }
    };

    function toast(msg, kind="info"){
      const box = $("#toast");
      box.textContent = msg;
      box.classList.remove("hidden");
      box.style.background = kind==="error" ? "#ef4444" : (kind==="ok" ? "#065f46" : "#111827");
      setTimeout(()=>box.classList.add("hidden"), 3000);
    }

    /* ========================== Audio ========================== */
    function initAudio() {
      if (state.audioInitialized) return;
      try {
        state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        state.audioInitialized = true;
        console.log("AudioContext inicializado.");
      } catch (e) {
        console.error("AudioContext n√£o suportado.", e);
        toast("√Åudio n√£o p√¥de ser inicializado.", "error");
      }
    }

    function playBeep() {
      if (!state.audioCtx || !state.alarmOn) return;
      try {
        const oscillator = state.audioCtx.createOscillator();
        const gainNode = state.audioCtx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(state.audioCtx.destination);
        
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(1000, state.audioCtx.currentTime); 
        gainNode.gain.setValueAtTime(0.5, state.audioCtx.currentTime);
        
        oscillator.start(state.audioCtx.currentTime);
        oscillator.stop(state.audioCtx.currentTime + 0.2);
      } catch (e) {
        console.error("Falha ao tocar bipe:", e);
      }
    }
    
    function playNotificationSound() {
      if (!state.audioCtx) return;
      try {
        const oscillator = state.audioCtx.createOscillator();
        const gainNode = state.audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(state.audioCtx.destination);
        oscillator.type = 'triangle'; 
        oscillator.frequency.setValueAtTime(1200, state.audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.3, state.audioCtx.currentTime); 
        oscillator.start(state.audioCtx.currentTime);
        oscillator.stop(state.audioCtx.currentTime + 0.1); 
      } catch (e) {
        console.error("Falha ao tocar som de notifica√ß√£o:", e);
      }
    }

    /* ========================== Modal Gen√©rico ========================== */
    const $modalOverlay = $("#modal-overlay");
    const $modalTitle = $("#modal-title");
    const $modalContent = $("#modal-content");
    const $modalSave = $("#modal-save");
    const $modalCancel = $("#modal-cancel");
    const $modalClose = $("#modal-close");

    let onModalSave = () => {};
    let onModalCancel = () => {};

    function openModal(title, contentHtml, saveCallback, cancelCallback = () => {}) {
      $modalTitle.textContent = title;
      $modalContent.innerHTML = contentHtml;
      onModalSave = saveCallback;
      onModalCancel = cancelCallback;
      $modalSave.textContent = "Salvar";
      $modalCancel.textContent = "Cancelar";
      $modalOverlay.classList.remove("hidden");
      $modalOverlay.classList.add("flex");
    }

    function closeModal() {
      $modalOverlay.classList.add("hidden");
      $modalOverlay.classList.remove("flex");
      $modalContent.innerHTML = "";
      state.editingItemId = null;
      onModalSave = () => {};
      onModalCancel = () => {};
    }

    $modalSave.addEventListener("click", () => onModalSave());
    $modalCancel.addEventListener("click", closeModal);
    $modalClose.addEventListener("click", closeModal);

    function openConfirmModal(text, callback) {
      $modalTitle.textContent = "Confirma√ß√£o";
      $modalContent.innerHTML = `<p>${text}</p>`;
      $modalSave.textContent = "Confirmar";
      $modalCancel.textContent = "Cancelar";
      
      onModalSave = () => {
        closeModal();
        callback(true);
      };
      
      onModalCancel = () => {
        closeModal();
        callback(false);
      };

      $modalOverlay.classList.remove("hidden");
      $modalOverlay.classList.add("flex");
    }
    
    function confirmBox(text) {
      return new Promise((resolve) => {
        openConfirmModal(text, (ok) => {
          resolve(ok);
        });
      });
    }

    /* ========================== Login / Logout ========================== */
    const USERS = { "ezequiel": "Gois", "larissa":"7524" };

    function showLogin(show){
      $("#login-overlay").classList.toggle("hidden", !show);
      $("#login-overlay").classList.toggle("flex", show);
      if (show) $("#login-user").focus();
    }

    function tryAutoLogin(){
      try {
        const raw = localStorage.getItem("sessionUser");
        if (!raw) return false;
        const sess = JSON.parse(raw);
        if (!sess || !USERS[sess.user]) return false;
        state.session = sess;
        return true;
      } catch(e){ return false; }
    }

    function login(user, pin){
      user = (user||"").trim().toLowerCase();
      pin = (pin||"").trim();
      if (USERS[user] && USERS[user] === pin){
        state.session = { user, ts: Date.now() };
        localStorage.setItem("sessionUser", JSON.stringify(state.session));
        
        const userRef = ref(db, `users/${user}`);
        set(userRef, { lastSeen: new Date().toISOString() });
        onDisconnect(userRef).set({ lastSeen: new Date(0).toISOString() });

        showLogin(false);
        toast("Bem-vindo!", "ok");
        
        listenForGlobalMessages();
        
        return true;
      }
      $("#login-msg").classList.remove("hidden");
      $("#login-msg").textContent = "Usu√°rio ou PIN inv√°lidos.";
      return false;
    }

    function logout(){
      if (state.session && state.session.user) {
        const userRef = ref(db, `users/${state.session.user}`);
        onDisconnect(userRef).cancel(); 
        set(userRef, { lastSeen: new Date(0).toISOString() }); 
      }
      stopListeningForGlobalMessages(); 

      localStorage.removeItem("sessionUser");
      state.session = null;
      
      $("#chat-contact-list").innerHTML = "";
      $("#chat-box").innerHTML = "";
      $("#chat-main-header").textContent = "Selecione um contato para conversar";
      $("#chat-input-area").classList.add("hidden");
      state.selectedChatUser = null;
      if (state.messageListener) off(state.messageListener);
      
      showLogin(true);
    }

    /* ========================== Data bindings ========================== */
    function bindRealtime(){
      onValue(ref(db, "settings"), (snap)=>{
        const s = snap.val();
        if (s) state.settings = {...state.settings, ...s};
        $("#al1").value = state.settings.alertLevels[0];
        $("#al2").value = state.settings.alertLevels[1];
        $("#al3").value = state.settings.alertLevels[2];
        $("#al4").value = state.settings.alertLevels[3];
        $("#alP").value = state.settings.persistentAlarmMinutes;
        $("#def-reason").value = state.settings.defaultReason || "";
      });

      onValue(ref(db, "saidas"), (snap)=>{
        const data = snap.val() || {};
        state.requests = Object.entries(data).map(([id, v])=> ({id, ...v}));
        renderSaidas();
      });

      onValue(ref(db, "s5Teams"), (snap)=>{
        const data = snap.val() || {};
        state.s5Teams = Object.entries(data).map(([id, v])=> ({id, ...v}));
        renderS5();
      });

      onValue(ref(db, "users"), (snap)=>{
        state.users = snap.val() || {};
        if(state.session) { 
          renderUserList();
          listenForGlobalMessages();
        }
      });
    }

    /* ========================== Render Sa√≠das ========================== */
    function renderSaidas(){
      const pendingAll = state.requests.filter(r => r.status==="pending" || r.status==="approved");
      
      pendingAll.sort((a, b) => {
          const orderA = a.order !== undefined ? a.order : new Date(a.requestTime).getTime();
          const orderB = b.order !== undefined ? b.order : new Date(b.requestTime).getTime();
          return orderA - orderB;
      });

      const history = state.requests.filter(r => r.status==="completed" || r.status==="rejected");
      $("#pending-count").textContent = pendingAll.length.toString();

      const pList = $("#pending-list");
      pList.innerHTML = "";
      if(pendingAll.length===0){
        pList.innerHTML = `<li class="text-sm opacity-70 italic">Ningu√©m na fila agora.</li>`;
      }
      const now = Date.now();

      pendingAll.forEach(req => {
        const isApproved = req.status === "approved";
        const li = document.createElement("li");
        li.className = isApproved ? "approved-item" : "pending-item";
        li.dataset.liId = req.id;
        li.draggable = true;
        li.dataset.dragId = req.id;

        const timeStr = new Date(isApproved?req.departureTime:req.requestTime||Date.now()).toLocaleTimeString("pt-BR");
        const left = document.createElement("div");
        
        const reason = req.reason || (isApproved ? (state.settings.defaultReason || "Banheiro") : "N/A");
        left.innerHTML = `<b>${req.userName}</b> <span class="text-xs opacity-60 ml-1">(${timeStr})</span>
                          <div class="text-xs mt-0.5">` +
                          (isApproved ? `Motivo: ${reason} | Decorrido: <span data-dur="${req.id}-out">${fmtDur(now - new Date(req.departureTime))}</span>`
                                      : `Espera: <span data-dur="${req.id}-wait">${fmtDur(now - new Date(req.requestTime))}</span>`)
                        + `</div>`;
        
        const right = document.createElement("div");
        right.className = "flex items-center gap-2";
        
        if (!isApproved){
          right.innerHTML = `<button class="btn-primary" data-act="approve" data-id="${req.id}">Liberar</button>
                             <button class="btn-danger" data-act="reject" data-id="${req.id}">Recusar</button>`;
        } else {
          right.innerHTML = `<button class="btn-secondary" data-act="return" data-id="${req.id}">Chegou</button>`;
        }
        right.innerHTML += `<button class="btn-icon" data-act="edit-saida" data-id="${req.id}">‚úèÔ∏è</button>
                            <button class="btn-icon" data-act="del-saida" data-id="${req.id}">üóë</button>`;

        li.append(left, right);
        pList.appendChild(li);
      });

      const histBox = $("#history");
      histBox.innerHTML = "";
      const query = ($("#hist-search").value||"").toLowerCase();
      const byDay = {};
      history.forEach(r=>{
        if (query && !r.userName.toLowerCase().includes(query)) return;
        const d = new Date(r.requestTime||r.departureTime||Date.now());
        const key = d.toLocaleDateString("pt-BR");
        (byDay[key] ||= []).push(r);
      });
      const days = Object.keys(byDay).sort((a,b)=>{
        const da = new Date(a.split("/").reverse().join("-"));
        const db = new Date(b.split("/").reverse().join("-"));
        return db-da;
      });
      if (days.length===0){
        histBox.innerHTML = `<div class="text-sm opacity-70 italic">Hist√≥rico vazio.</div>`;
      }
      days.forEach(day=>{
        const hdr = document.createElement("div");
        hdr.className = "rounded-xl bg-indigo-100 dark:bg-indigo-900/30 text-indigo-800 dark:text-indigo-200 px-3 py-2 font-extrabold flex items-center justify-between cursor-pointer";
        hdr.textContent = day;
        hdr.dataset.day = day; 
        const caret = document.createElement("span"); caret.textContent = "‚ñº"; caret.className = "transition-transform"; hdr.append(caret);
        const list = document.createElement("ul"); list.className="grid gap-1 bg-white dark:bg-slate-800 rounded-b-xl p-2 hidden"; // Come√ßa escondido

        byDay[day].sort((a,b)=>(new Date(b.requestTime||b.departureTime))-(new Date(a.requestTime||a.departureTime))).forEach(r=>{
          const li = document.createElement("li");
          li.className = "flex items-center justify-between border-b border-slate-200/60 dark:border-slate-700/40 py-1";
          const t1 = r.requestTime ? new Date(r.requestTime).toLocaleTimeString("pt-BR") : "";
          const t_dep = r.departureTime ? new Date(r.departureTime).toLocaleTimeString("pt-BR") : "";
          const t_ret = r.returnTime ? new Date(r.returnTime).toLocaleTimeString("pt-BR") : "";
          
          const status = r.status==="completed" ? "Liberado" : (r.status === "rejected" ? "Recusado" : "Pendente");
          const dur = (r.returnTime && r.departureTime) ? ` (${fmtDur(new Date(r.returnTime)-new Date(r.departureTime))})` : "";
          const reason = r.reason || (r.status === 'completed' ? (state.settings.defaultReason || 'Banheiro') : (r.status === 'rejected' ? 'Recusado/Cancelado' : 'N/A'));

          li.innerHTML = `<div class="min-w-0 truncate">
                            <b>${r.userName}</b> ‚Äî <span class="${r.status==='completed'?'text-emerald-600':'text-rose-600'} font-bold">${status}</span>
                            <br><span class="text-xs opacity-70">Solicitado: ${t1} ${r.departureTime ? `| Sa√≠da: ${t_dep}` : ''} ${r.returnTime ? `| Retorno: ${t_ret}` : ''} ${dur}</span>
                            <br><span class="text-xs opacity-80">Motivo: ${reason}</span>
                          </div>
                          <div class="flex gap-1">
                            <button class="btn-icon" data-act="edit-saida" data-id="${r.id}">‚úèÔ∏è</button>
                            <button class="btn-icon" data-act="del-saida" data-id="${r.id}">üóë</button>
                          </div>`;
          list.appendChild(li);
        });
        histBox.append(hdr, list);
      });
    }

    /* ========================== Render S5 ========================== */
    function renderS5(){
      const ul = $("#s5-list");
      ul.innerHTML = "";
      if (state.s5Teams.length===0){
        ul.innerHTML = `<li class="text-sm opacity-70 italic">Nenhuma equipe 5S registrada.</li>`;
        return;
      }
      state.s5Teams.forEach(team=>{
        const li = document.createElement("li");
        li.className = `flex items-center justify-between rounded-xl p-3 border ${team.isCompleted?'bg-emerald-50 border-emerald-400':'bg-rose-50 border-rose-400'} dark:border-transparent dark:${team.isCompleted?'bg-emerald-900/20':'bg-rose-900/20'}`;
        const list = [team.person1,team.person2,team.person3,team.person4].filter(Boolean).join(", ");
        const label = document.createElement("div");
        const reg = new Date(team.registrationTime||Date.now()).toLocaleDateString("pt-BR");
        label.innerHTML = `<div class="font-extrabold">${reg} ‚Äî ${team.shift}</div><div class="text-sm opacity-80">${list}</div>`;
        
        const right = document.createElement("div");
        right.className = "flex items-center gap-2";
        
        const chk = document.createElement("input");
        chk.type = "checkbox"; chk.checked = !!team.isCompleted;
        chk.addEventListener("change", ()=> update(ref(db, "s5Teams/"+team.id), { isCompleted: chk.checked }));
        
        const editBtn = document.createElement("button");
        editBtn.className = "btn-icon";
        editBtn.textContent = "‚úèÔ∏è";
        editBtn.dataset.act = "edit-s5";
        editBtn.dataset.id = team.id;
        
        const delBtn = document.createElement("button");
        delBtn.className = "btn-icon";
        delBtn.textContent = "üóë";
        delBtn.dataset.act = "del-s5";
        delBtn.dataset.id = team.id;

        right.append(chk, editBtn, delBtn);
        li.append(label,right);
        ul.appendChild(li);
      });
    }

    /* ========================== Render Chat (1-para-1) ========================== */
    function renderUserList() {
      const $list = $("#chat-contact-list");
      if (!$list) return;
      $list.innerHTML = "";
      const currentUser = state.session?.user;
      if (!currentUser) return;
      
      const admins = ["Ezequiel", "Larissa"];
      
      admins.forEach(adminName => {
        if (adminName === currentUser) return; 
        
        const lastSeenDate = new Date(state.users[adminName]?.lastSeen || 0);
        const isOnline = (new Date() - lastSeenDate) < 5 * 60 * 1000; 
        
        const div = document.createElement("div");
        div.className = "chat-contact";
        div.dataset.userName = adminName;
        
        div.innerHTML = `
          <div class="chat-contact-details">
            <span class="presence-dot ${isOnline ? 'online-dot' : 'offline-dot'}"></span>
            <span class="chat-contact-name">${adminName} (Admin)</span>
          </div>
        `;
        
        if (state.selectedChatUser === adminName) {
          div.classList.add("active");
        }
        div.onclick = () => selectChat(adminName);
        $list.appendChild(div);
      });
      
      const divider = document.createElement("div");
      divider.className = "px-4 pt-2 pb-1 text-xs font-bold opacity-60";
      divider.textContent = "ALUNOS";
      $list.appendChild(divider);

      Object.keys(state.users)
        .filter(userName => userName !== currentUser)
        .filter(userName => !admins.includes(userName))
        .sort()
        .forEach(userName => {
          const lastSeenDate = new Date(state.users[userName]?.lastSeen || 0);
          const isOnline = (new Date() - lastSeenDate) < 5 * 60 * 1000;

          const div = document.createElement("div");
          div.className = "chat-contact";
          div.dataset.userName = userName;
          
          div.innerHTML = `
            <div class="chat-contact-details">
              <span class="presence-dot ${isOnline ? 'online-dot' : 'offline-dot'}"></span>
              <span class="chat-contact-name">${userName}</span>
            </div>
          `;
          
          if (state.selectedChatUser === userName) {
            div.classList.add("active");
          }
          div.onclick = () => selectChat(userName);
          $list.appendChild(div);
        });
    }

    function selectChat(userName) {
      if (!state.session || !state.session.user) return;
      
      state.selectedChatUser = userName;
      state.lastMessageTimestamp = 0;
      renderUserList(); 

      state.unreadChats.delete(userName);
      updateNotificationBadge();

      $("#chat-main-header").textContent = `Conversando com ${userName}`;
      $("#chat-input-area").classList.remove("hidden");
      $("#chat-box").innerHTML = `<p class="text-sm opacity-70 italic p-4">Carregando mensagens...</p>`;

      const currentUser = state.session.user;
      const conversation_id = [currentUser, userName].sort().join('_');
      
      if (state.messageListener) {
        off(state.messageListener); 
      }

      const messagesRef = ref(db, `messages/${conversation_id}`);
      state.messageListener = messagesRef; 

      onValue(messagesRef, (snap) => {
        const data = snap.val() || {};
        state.currentMessages = Object.entries(data).map(([id, v]) => ({ id, ...v }));
        state.currentMessages.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
        renderSelectedChatMessages();
      });
    }
    
    function renderSelectedChatMessages() {
        const box = $("#chat-box");
        if (!box) return;
        if (!state.selectedChatUser) {
          box.innerHTML = `<p class="text-sm opacity-70 italic p-4">Selecione um contato para conversar</p>`;
          return;
        }

        const currentUser = state.session.user;
        box.innerHTML = "";
        
        if (state.currentMessages.length === 0) {
            state.lastMessageTimestamp = 0; 
            box.innerHTML = `<p class="text-sm opacity-70 italic p-4">Nenhuma mensagem ainda.</p>`;
            return;
        }

        state.currentMessages.forEach(msg => {
            const isSent = (msg.from === currentUser);
            
            const msgEl = document.createElement("div");
            msgEl.className = `chat-msg ${isSent ? 'sent' : 'received'}`;
            
            if (!isSent) {
              const userLabel = document.createElement("span");
              userLabel.className = "chat-msg-user";
              userLabel.textContent = cleanName(msg.from); 
              msgEl.append(userLabel);
            }
            
            const bubble = document.createElement("div");
            bubble.className = "chat-msg-bubble";
            bubble.textContent = msg.text || "";
            
            const timeEl = document.createElement("span");
            timeEl.className = "chat-msg-time";
            timeEl.textContent = formatChatTime(msg.timestamp);

            msgEl.append(bubble, timeEl);
            
            if (isSent) {
                const actionsDiv = document.createElement("div");
                actionsDiv.className = "chat-msg-actions";
                actionsDiv.innerHTML = `
                    <button class="btn-secondary btn-icon" data-act="edit-chat" data-id="${msg.id}">‚úèÔ∏è</button>
                    <button class="btn-danger btn-icon" data-act="del-chat" data-id="${msg.id}">üóë</button>
                `;
                msgEl.appendChild(actionsDiv);
            }

            box.appendChild(msgEl);
        });

        const lastMsg = state.currentMessages[state.currentMessages.length - 1];
        if (lastMsg) {
          const lastMsgTime = new Date(lastMsg.timestamp).getTime();
          
          if (lastMsg.from !== currentUser && lastMsgTime > state.lastMessageTimestamp) {
            playNotificationSound();
          }
          state.lastMessageTimestamp = lastMsgTime;
        }

        box.scrollTop = box.scrollHeight;
    }

    /* ========================== Actions (Sa√≠das) ========================== */
    function addStudent(){
      const name = cleanName($("#input-name").value);
      if (!name) return toast("Digite o nome do aluno.", "error");
      
      const payload = {
        userName: name,
        status: "pending",
        requestTime: new Date().toISOString(),
        order: Date.now() 
      };

      push(ref(db, "saidas"), payload).then(()=>{
        $("#input-name").value = "";
        toast(`"${name}" adicionado √† fila.`, "ok");
      });
    }

    function updateQueueOrder() {
        const updates = {};
        const items = $$("#pending-list li[data-drag-id]");
        
        items.forEach((li, index) => {
            const id = li.dataset.dragId;
            if (id) {
                updates[`saidas/${id}/order`] = index;
            }
        });

        if (Object.keys(updates).length > 0) {
            update(ref(db), updates).then(() => {
                toast("Ordem da fila atualizada.", "ok");
            }).catch(err => {
                toast("Erro ao salvar ordem.", "error");
                renderSaidas();
            });
        }
    }

    function approve(id){
      update(ref(db, "saidas/"+id), {
        status: "approved",
        departureTime: new Date().toISOString(),
        reason: state.settings.defaultReason || "Banheiro"
      });
    }
    function reject(id){
      update(ref(db, "saidas/"+id), {
        status: "rejected",
        returnTime: new Date().toISOString(),
        reason: "Recusado/Cancelado"
      });
    }
    
    // *** CORRE√á√ÉO APLICADA AQUI ***
    function arrived(id){
      // Envia a atualiza√ß√£o para o Firebase
      update(ref(db, "saidas/"+id), {
        status: "completed",
        returnTime: new Date().toISOString()
      });
      
      // Limpa o estado local IMEDIATAMENTE para parar o alarme (corrige a race condition)
      if (state.alarmingStudents.has(id)) {
        console.log(`Limpando alarme (imediato) para ${id}`);
        state.alarmingStudents.delete(id);
      }
      if (state.alarmLevelsCache[id]) {
        delete state.alarmLevelsCache[id];
      }
    }
    
    async function removeReq(id){
      const ok = await confirmBox("Tem certeza que deseja excluir este registro de sa√≠da?");
      if (!ok) return;
      remove(ref(db, "saidas/"+id));
      toast("Registro exclu√≠do.", "ok");
    }

    function openEditSaidaModal(id) {
      const req = state.requests.find(r => r.id === id);
      if (!req) return toast("Registro n√£o encontrado.", "error");

      state.editingItemId = id;
      const currentReason = req.reason || (req.status === 'approved' || req.status === 'completed' ? (state.settings.defaultReason || 'Banheiro') : '');
      
      const requestTimeLocal = formatDateTimeLocal(req.requestTime);
      const departureTimeLocal = formatDateTimeLocal(req.departureTime);
      const returnTimeLocal = formatDateTimeLocal(req.returnTime);

      const content = `
        <div class="field">
          <label>Nome do Aluno</label>
          <input id="edit-saida-name" class="input" value="${req.userName}">
        </div>
        <div class="field">
          <label>Motivo</label>
          <input id="edit-saida-reason" class="input" value="${currentReason}" placeholder="Motivo da sa√≠da">
        </div>
        <div class="field">
          <label>Hora de Solicita√ß√£o</label>
          <input id="edit-request-time" type="datetime-local" class="input" value="${requestTimeLocal}">
        </div>
        <div class="field">
          <label>Hora de Sa√≠da</label>
          <input id="edit-departure-time" type="datetime-local" class="input" value="${departureTimeLocal}">
        </div>
        <div class="field">
          <label>Hora de Retorno</label>
          <input id="edit-return-time" type="datetime-local" class="input" value="${returnTimeLocal}">
        </div>
      `;
      openModal("Editar Sa√≠da", content, () => saveSaida(id));
    }

    function saveSaida(id) {
      const name = cleanName($("#edit-saida-name").value);
      const reason = ($("#edit-saida-reason").value || "").trim();
      const requestTime = parseDateTimeLocal($("#edit-request-time").value);
      const departureTime = parseDateTimeLocal($("#edit-departure-time").value);
      const returnTime = parseDateTimeLocal($("#edit-return-time").value);

      if (!name) return toast("O nome n√£o pode ficar em branco.", "error");

      const updates = {
        userName: name,
        reason: reason || (state.settings.defaultReason || "Banheiro"),
        requestTime: requestTime,
        departureTime: departureTime,
        returnTime: returnTime,
      };

      if (!requestTime) updates.requestTime = null;
      if (!departureTime) updates.departureTime = null;
      if (!returnTime) updates.returnTime = null;
      
      const currentReq = state.requests.find(r => r.id === id);
      if (updates.returnTime) {
          updates.status = "completed";
      } else if (updates.departureTime) {
          updates.status = "approved";
      } else {
          updates.status = "pending";
      }
      if (currentReq.status === 'rejected' && !updates.departureTime && !updates.returnTime) {
          updates.status = "rejected";
      }

      update(ref(db, "saidas/" + id), updates).then(() => {
        toast("Registro atualizado!", "ok");
        closeModal();
      });
    }

    /* ========================== Actions (S5) ========================== */
    function addS5Team() {
      const p = ["#s5-p1", "#s5-p2", "#s5-p3", "#s5-p4"].map(sel => cleanName($(sel).value));
      const payload = {
        person1: p[0] || "Vago",
        person2: p[1] || "Vago",
        person3: p[2] || "Vago",
        person4: p[3] || "Vago",
        shift: $("#s5-shift").value,
        isCompleted: false,
        registrationTime: new Date().toISOString()
      };
      push(ref(db, "s5Teams"), payload).then(() => {
        ["#s5-p1", "#s5-p2", "#s5-p3", "#s5-p4"].forEach(sel => $(sel).value = "");
        toast("Equipe adicionada.", "ok");
      });
    }

    async function removeS5Team(id) {
      const ok = await confirmBox("Tem certeza que deseja excluir esta equipe 5S?");
      if (!ok) return;
      remove(ref(db, "s5Teams/" + id));
      toast("Equipe exclu√≠da.", "ok");
    }

    function openEditS5Modal(id) {
      const team = state.s5Teams.find(t => t.id === id);
      if (!team) return toast("Equipe n√£o encontrada.", "error");

      state.editingItemId = id;
      const content = `
        <div class="field">
          <label>Pessoa 1</label>
          <input id="edit-s5-p1" class="input" value="${team.person1 || ''}">
        </div>
        <div class="field">
          <label>Pessoa 2</label>
          <input id="edit-s5-p2" class="input" value="${team.person2 || ''}">
        </div>
        <div class="field">
          <label>Pessoa 3</label>
          <input id="edit-s5-p3" class="input" value="${team.person3 || ''}">
        </div>
        <div class="field">
          <label>Pessoa 4</label>
          <input id="edit-s5-p4" class="input" value="${team.person4 || ''}">
        </div>
        <div class="field">
          <label>Turno</label>
          <select id="edit-s5-shift" class="input">
            <option ${team.shift === 'Manh√£' ? 'selected' : ''}>Manh√£</option>
            <option ${team.shift === 'Tarde' ? 'selected' : ''}>Tarde</option>
            <option ${team.shift === 'Noite' ? 'selected' : ''}>Noite</option>
          </select>
        </div>
      `;
      openModal("Editar Equipe 5S", content, () => saveS5Team(id));
    }

    function saveS5Team(id) {
      const p = ["#edit-s5-p1", "#edit-s5-p2", "#edit-s5-p3", "#edit-s5-p4"].map(sel => cleanName($(sel).value));
      const payload = {
        person1: p[0] || "Vago",
        person2: p[1] || "Vago",
        person3: p[2] || "Vago",
        person4: p[3] || "Vago",
        shift: $("#edit-s5-shift").value,
      };

      update(ref(db, "s5Teams/" + id), payload).then(() => {
        toast("Equipe atualizada!", "ok");
        closeModal();
      });
    }

    /* ========================== Actions (Chat) ========================== */
    
    function sendChatMessage() {
        const input = $("#chat-input");
        const text = input.value.trim();
        if (!text) return;
        
        const currentUser = state.session ? state.session.user : null;
        if (!currentUser) {
            return toast("Voc√™ precisa estar logado para enviar mensagens.", "error");
        }
        if (!state.selectedChatUser) {
            return toast("Selecione um contato para enviar a mensagem.", "error");
        }
        
        const targetUser = state.selectedChatUser;
        const conversation_id = [currentUser, targetUser].sort().join('_');

        const payload = {
            from: currentUser,
            to: targetUser,
            text: text,
            timestamp: new Date().toISOString(),
            read: false
        };

        push(ref(db, `messages/${conversation_id}`), payload).then(() => {
            input.value = "";
            input.focus();
        }).catch(err => {
            toast("Erro ao enviar mensagem.", "error");
        });
    }

    async function deleteChatMessage(id) {
        const msg = state.currentMessages.find(m => m.id === id);
        const currentUser = state.session?.user;
        const targetUser = state.selectedChatUser;
        
        if (!msg || !currentUser || !targetUser) return;
        
        if (msg.from === currentUser) {
          const ok = await confirmBox("Tem certeza que deseja excluir esta mensagem?");
          if (ok) {
              const conversation_id = [currentUser, targetUser].sort().join('_');
              remove(ref(db, `messages/${conversation_id}/${id}`));
              toast("Mensagem exclu√≠da.", "ok");
          }
        }
    }

    function openEditChatMessageModal(id) {
        const msg = state.currentMessages.find(m => m.id === id);
        if (!msg || msg.from !== state.session.user) return toast("Mensagem n√£o encontrada.", "error");

        const content = `
            <div class="field">
              <label>Editar Mensagem</label>
              <textarea id="edit-chat-text" class="input" rows="3">${msg.text}</textarea>
            </div>
        `;
        openModal("Editar Mensagem", content, () => saveChatMessage(id));
    }

    function saveChatMessage(id) {
        const newText = $("#edit-chat-text").value.trim();
        const currentUser = state.session?.user;
        const targetUser = state.selectedChatUser;

        if (newText && currentUser && targetUser) {
            const conversation_id = [currentUser, targetUser].sort().join('_');
            update(ref(db, `messages/${conversation_id}/${id}`), { text: newText });
            toast("Mensagem atualizada!", "ok");
            closeModal();
        } else {
            toast("A mensagem n√£o pode ficar vazia.", "error");
        }
    }
    
    /* ========================== Notifica√ß√µes de Chat ========================== */
    
    function stopListeningForGlobalMessages() {
      state.globalMessageListeners.forEach(({ listenerRef, listenerFn }) => {
        off(listenerRef, 'value', listenerFn); 
      });
      state.globalMessageListeners = []; 
      state.unreadChats = new Set(); 
      updateNotificationBadge(); 
    }
    
    function listenForGlobalMessages() {
      if (!state.session || !state.session.user) return;
      
      stopListeningForGlobalMessages(); 
      const currentUser = state.session.user;

      const admins = ["Ezequiel", "Larissa"];
      const otherUsers = Object.keys(state.users);
      const allPossiblePartners = [...new Set([...admins, ...otherUsers])];

      allPossiblePartners.forEach(partner => {
        if (partner === currentUser) return;

        const conversation_id = [currentUser, partner].sort().join('_');
        const listenerRef = ref(db, `messages/${conversation_id}`);
        
        const listenerFn = (snap) => {
          const data = snap.val() || {};
          const messages = Object.values(data);
          if (messages.length === 0) {
             state.unreadChats.delete(partner);
             updateNotificationBadge();
             return;
          }
          
          const lastMessage = messages[messages.length - 1];

          if (lastMessage && lastMessage.from === partner && state.selectedChatUser !== partner) {
            state.unreadChats.add(partner);
          } else if (state.selectedChatUser === partner) {
            state.unreadChats.delete(partner);
          }
          
          updateNotificationBadge();
        };
        
        onValue(listenerRef, listenerFn); 
        state.globalMessageListeners.push({ listenerRef, listenerFn });
      });
    }
    
    function updateNotificationBadge() {
      const $badge = $("#chat-notification-badge");
      if (state.unreadChats.size > 0) {
        $badge.textContent = state.unreadChats.size;
        $badge.classList.remove("hidden");
      } else {
        $badge.classList.add("hidden");
      }
    }
    
    /* ========================== Settings ========================== */
    function saveSettings(){
      const vals = [$("#al1").value,$("#al2").value,$("#al3").value,$("#al4").value].map(v=>parseInt(v,10));
      const pers = parseInt($("#alP").value,10);
      if (vals.some(v=>!v||v<=0) || !pers || pers<=0){
        return toast("Valores inv√°lidos.", "error");
      }
      for (let i=0;i<vals.length-1;i++){
        if (vals[i] >= vals[i+1]) return toast("Alertas devem ser crescentes.", "error");
      }
      if (vals[vals.length-1] >= pers) return toast("Alarme cont√≠nuo deve ser maior que o 4¬∫ alerta.", "error");
      const payload = {
        alertLevels: vals,
        persistentAlarmMinutes: pers,
        defaultReason: $("#def-reason").value || "Banheiro"
      };
      set(ref(db, "settings"), payload).then(()=>toast("Configura√ß√µes salvas!", "ok"));
    }

    /* ========================== Backup / Reset ========================== */
    async function downloadBackup(){
      const [saidasSnap, s5Snap, confSnap, messagesSnap, usersSnap] = await Promise.all([
        get(ref(db, "saidas")),
        get(ref(db, "s5Teams")),
        get(ref(db, "settings")),
        get(ref(db, "messages")),
        get(ref(db, "users"))
      ]);
      const content = {
        saidas: saidasSnap.val() || {},
        s5Teams: s5Snap.val() || {},
        settings: confSnap.val() || {},
        messages: messagesSnap.val() || {},
        users: usersSnap.val() || {},
        exportedAt: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(content, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `backup_gerenciador_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    
    async function uploadBackup(file){
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if (!data || typeof data !== "object") throw new Error("Arquivo inv√°lido.");
        const ok = await confirmBox("Importar backup COMPLETO e substituir dados na nuvem?");
        if (!ok) throw new Error("cancel");
        
        const tasks = [];
        if (data.saidas) tasks.push(set(ref(db, "saidas"), data.saidas));
        if (data.s5Teams) tasks.push(set(ref(db, "s5Teams"), data.s5Teams));
        if (data.settings) tasks.push(set(ref(db, "settings"), data.settings));
        if (data.messages) tasks.push(set(ref(db, "messages"), data.messages)); 
        if (data.users) tasks.push(set(ref(db, "users"), data.users));
        
        await Promise.all(tasks);
        toast("Backup importado!", "ok");
      }catch(e){
        if (e.message!=="cancel") toast("Falha ao importar.", "error");
      }
    }
    
    async function resetAll(){
      const ok = await confirmBox("Resetar TUDO (sa√≠das, 5S, chats, utilizadores, configura√ß√µes)?");
      if (!ok) return;
      await Promise.all([
        remove(ref(db, "saidas")),
        remove(ref(db, "s5Teams")),
        remove(ref(db, "settings")),
        remove(ref(db, "messages")),
        remove(ref(db, "users"))
      ]);
      toast("Tudo resetado.", "ok");
    }

    /* ========================== Clock & alerts (L√ìGICA CORRIGIDA) ========================== */
    function startClock(){
      if (state.timers.clock) clearInterval(state.timers.clock);
      if (state.timers.alert) clearInterval(state.timers.alert);
      state.timers.alert = null; 

      // Timer principal (a cada 1 segundo) - Atualiza UI e dispara bipes de TRANSI√á√ÉO
      state.timers.clock = setInterval(()=>{
        const now = Date.now();
        $("#clock").textContent = new Date().toLocaleTimeString("pt-BR", {hour12:false});
        
        let shouldBeep = false; // Flag para tocar o bipe de transi√ß√£o
        const { alertLevels, persistentAlarmMinutes } = state.settings;

        state.requests.forEach(r=>{
          const el = document.querySelector(`#pending-list [data-li-id="${r.id}"]`); 
          const currentVisualLevel = state.alarmLevelsCache[r.id] || 0;
          let newVisualLevel = 0; // N√≠vel 0 = normal

          if (r.status==="pending"){
            const durEl = document.querySelector(`[data-dur="${r.id}-wait"]`);
            if (durEl) durEl.textContent = fmtDur(now - new Date(r.requestTime));
          
          } else if (r.status==="approved"){
            const durEl = document.querySelector(`[data-dur="${r.id}-out"]`);
            if (!r.departureTime) return;
            
            const departureTime = new Date(r.departureTime).getTime();
            const elapsedMs = now - departureTime;
            if (durEl) durEl.textContent = fmtDur(elapsedMs);

            const elapsedMinutes = elapsedMs / 60000;
            
            let alertClass = '';
            if (elapsedMinutes >= alertLevels[0] && elapsedMinutes < alertLevels[1]) {
                alertClass = 'alarm-level-1';
                newVisualLevel = 1;
            }
            else if (elapsedMinutes >= alertLevels[1] && elapsedMinutes < alertLevels[2]) {
                alertClass = 'alarm-level-2';
                newVisualLevel = 2;
            }
            else if (elapsedMinutes >= alertLevels[2] && elapsedMinutes < alertLevels[3]) {
                alertClass = 'alarm-level-3';
                newVisualLevel = 3;
            }
            else if (elapsedMinutes >= alertLevels[3]) { 
                alertClass = 'alarm-level-4';
                newVisualLevel = 4;
            }

            if (el) {
                el.classList.remove('alarm-level-1', 'alarm-level-2', 'alarm-level-3', 'alarm-level-4');
                if(alertClass) el.classList.add(alertClass);
            }
            
            if (newVisualLevel > currentVisualLevel) {
                console.log(`Bipe de Transi√ß√£o para: ${r.userName} (N√≠vel ${newVisualLevel})`);
                shouldBeep = true; 
                state.alarmLevelsCache[r.id] = newVisualLevel; 
            }
            
            if (elapsedMinutes >= persistentAlarmMinutes) {
              if (!state.alarmingStudents.has(r.id)) {
                console.log(`Alarme PERSISTENTE para: ${r.userName}`);
                state.alarmingStudents.add(r.id);
                shouldBeep = true; 
              }
            } else {
              if (state.alarmingStudents.has(r.id)) {
                  state.alarmingStudents.delete(r.id);
              }
            }
          } 
          
          // *** CORRE√á√ÉO: Usando ELSE para limpar ***
          // S√≥ roda se o status for "completed" ou "rejected"
          else { 
             if (state.alarmLevelsCache[r.id]) {
                delete state.alarmLevelsCache[r.id];
             }
             if (state.alarmingStudents.has(r.id)) {
                console.log(`Limpando alarme (Loop) para ${r.userName} (Status: ${r.status})`);
                state.alarmingStudents.delete(r.id);
             }
             if (el) { // el ser√° null se o item j√° foi para o hist√≥rico
                el.classList.remove('alarm-level-1', 'alarm-level-2', 'alarm-level-3', 'alarm-level-4');
             }
          }
        }); // Fim do loop forEach

        if (shouldBeep) {
            playBeep();
        }

      }, 1000); // Fim do timer de 1 segundo

      // Timer de Alarme PERSISTENTE (a cada 5 segundos)
      state.timers.alert = setInterval(() => {
        if (state.alarmingStudents.size > 0 && state.alarmOn) {
            console.log("Bipe de alarme persistente (Repeti√ß√£o)...");
            playBeep();
        }
      }, 5000); 
    }
    /* ========================== FIM DA L√ìGICA DE ALARME ========================== */


    /* ========================== Tabs & Events ========================== */
    function activateTab(id){
      $$(".tab-btn").forEach(b=>b.classList.remove("active"));
      $$("div[id^='tab-']").forEach(c=>c.classList.add("hidden")); 
      
      const $btn = $(`[data-tab="${id}"]`);
      const $tab = $(`#tab-${id}`);
      
      if ($btn) $btn.classList.add("active");
      if ($tab) $tab.classList.remove("hidden");
      
      if (id === 'chat' && state.selectedChatUser) {
          state.unreadChats.delete(state.selectedChatUser);
          updateNotificationBadge();
      }
    }

    function bindEvents(){
      document.body.addEventListener('click', initAudio, { once: true });
      document.body.addEventListener('input', initAudio, { once: true });

      $("#btn-add").addEventListener("click", addStudent);
      
      const pList = $("#pending-list");

      pList.addEventListener("click", (e)=>{
        const btn = e.target.closest("button[data-act]");
        if (!btn) return;
        const act = btn.dataset.act, id = btn.dataset.id;
        if (act==="approve") approve(id);
        if (act==="reject") reject(id);
        if (act==="return") arrived(id); // *** CHAMA A FUN√á√ÉO CORRIGIDA ***
        if (act==="del-saida") removeReq(id);
        if (act==="edit-saida") openEditSaidaModal(id);
      });

      // Drag-n-Drop (Fila)
      let dragSrcId = null;

      function cleanupDragStyles() {
           $$('#pending-list li').forEach(li => {
              li.classList.remove('drag-over-top', 'drag-over-bottom', 'dragging');
          });
          dragSrcId = null;
      }

      pList.addEventListener("dragstart", (e) => {
          const li = e.target.closest('li[data-drag-id]');
          if (!li || e.target.tagName === 'BUTTON') return e.preventDefault();
          
          dragSrcId = li.dataset.dragId;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', dragSrcId);
          
          setTimeout(() => {
              if (dragSrcId) li.classList.add("dragging");
          }, 0);
      });

      pList.addEventListener("dragover", (e) => {
          e.preventDefault();
          if (!dragSrcId) return;
          
          e.dataTransfer.dropEffect = 'move';
          const destLi = e.target.closest('li[data-drag-id]');
          
          $$('#pending-list li').forEach(li => {
              li.classList.remove('drag-over-top', 'drag-over-bottom');
          });

          if (!destLi || destLi.dataset.dragId === dragSrcId) return;

          const rect = destLi.getBoundingClientRect();
          const midY = rect.top + rect.height / 2;
          
          if (e.clientY < midY) {
              destLi.classList.add('drag-over-top');
          } else {
              destLi.classList.add('drag-over-bottom');
          }
      });

      pList.addEventListener("dragleave", (e) => {
          const destLi = e.target.closest('li[data-drag-id]');
          if (destLi) {
              destLi.classList.remove('drag-over-top', 'drag-over-bottom');
          }
      });

      pList.addEventListener("drop", (e) => {
          e.preventDefault();
          if (!dragSrcId) return cleanupDragStyles();

          const destLi = e.target.closest('li[data-drag-id]');
          if (!destLi || destLi.dataset.dragId === dragSrcId) {
              return cleanupDragStyles();
          }

          const srcLi = pList.querySelector(`li[data-drag-id="${dragSrcId}"]`);
          if (!srcLi) return cleanupDragStyles();

          const rect = destLi.getBoundingClientRect();
          const midY = rect.top + rect.height / 2;
          if (e.clientY < midY) {
              pList.insertBefore(srcLi, destLi);
          } else {
              pList.insertBefore(srcLi, destLi.nextSibling);
          }
          
          updateQueueOrder(); 
          cleanupDragStyles();
      });

      pList.addEventListener("dragend", (e) => {
          cleanupDragStyles();
      });

      $("#history").addEventListener("click", (e)=>{
        const btn = e.target.closest("button[data-act]");
        if (btn){
          e.stopPropagation();
          const act = btn.dataset.act, id = btn.dataset.id;
          if (act==="del-saida") removeReq(id);
          if (act==="edit-saida") openEditSaidaModal(id);
          return;
        }
        
        const hdr = e.target.closest("div[data-day]");
        if(hdr) {
          const list = hdr.nextElementSibling;
          if(list) list.classList.toggle("hidden");
          const caret = hdr.querySelector("span");
          if(caret) caret.classList.toggle("rotate-180");
        }
      });
      
      $("#hist-search").addEventListener("input", renderSaidas);
      
      $("#s5-add").addEventListener("click", addS5Team);

      $("#s5-list").addEventListener("click", (e)=>{
        const btn = e.target.closest("button[data-act]");
        if (!btn) return;
        const act = btn.dataset.act, id = btn.dataset.id;
        if (act==="edit-s5") openEditS5Modal(id);
        if (act==="del-s5") removeS5Team(id);
      });

      // Eventos do Chat 1-para-1
      $("#chat-send").addEventListener("click", sendChatMessage);
      $("#chat-input").addEventListener("keypress", (e) => {
          if (e.key === "Enter" && !e.shiftKey) { 
              e.preventDefault();
              sendChatMessage();
          }
      });
      
      $("#chat-box").addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-act]");
          if (!btn) return;
          const act = btn.dataset.act;
          const id = btn.dataset.id;
          if (act === "del-chat") deleteChatMessage(id);
          if (act === "edit-chat") openEditChatMessageModal(id);
      });

      $("#btn-save-settings").addEventListener("click", saveSettings);

      $("#ddm-header").addEventListener("click", ()=> {
        $("#ddm").classList.toggle("hidden");
        $("#ddm-caret").classList.toggle("rotate-180");
      });
      $("#btn-backup-download").addEventListener("click", downloadBackup);
      $("#file-backup").addEventListener("change", (e)=> e.target.files[0] && uploadBackup(e.target.files[0]));
      $("#btn-reset").addEventListener("click", resetAll);

      $$(".tab-btn").forEach(b=> b.addEventListener("click", ()=> activateTab(b.dataset.tab)));

      $("#alarm-pill").addEventListener("click", () => {
        state.alarmOn = !state.alarmOn;
        const pill = $("#alarm-pill");
        if (state.alarmOn) {
            pill.textContent = "ALARME: LIGADO";
            pill.classList.remove("bg-rose-200", "text-rose-800", "dark:bg-rose-800", "dark:text-rose-200");
            pill.classList.add("bg-emerald-200", "text-emerald-800", "dark:bg-emerald-800", "dark:text-emerald-200");
            toast("Alarmes ligados.", "ok");
        } else {
            pill.textContent = "ALARME: DESLIGADO";
            pill.classList.add("bg-rose-200", "text-rose-800", "dark:bg-rose-800", "dark:text-rose-200");
            pill.classList.remove("bg-emerald-200", "text-emerald-800", "dark:bg-emerald-800", "dark:text-emerald-200");
            toast("Alarmes silenciados.", "info");
        }
      });

      $("#login-btn").addEventListener("click", ()=> {
        initAudio();
        login($("#login-user").value, $("#login-pin").value)
      });
      $("#logout-btn").addEventListener("click", logout);
    }

    /* ========================== Boot ========================== */
    function boot(){
      if (tryAutoLogin()) {
        const userRef = ref(db, `users/${state.session.user}`);
        set(userRef, { lastSeen: new Date().toISOString() });
        onDisconnect(userRef).set({ lastSeen: new Date(0).toISOString() });
        listenForGlobalMessages();
      } else {
        showLogin(true);
      }
      
      bindEvents();
      bindRealtime();
      startClock();
      activateTab("saidas");
    }

    // Iniciar a aplica√ß√£o
    boot();
  </script>
</body>
</html>
