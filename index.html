<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lista de Sa√≠das</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <script>
    (function() {
      document.documentElement.classList.add("dark");
      document.documentElement.style.opacity = "0";
    })();
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class', // Ainda necess√°rio para o Tailwind funcionar
      theme: {
        extend: {
          fontFamily: { inter: ['Inter', 'system-ui', 'ui-sans-serif']},
          colors: {
            brand: {
              DEFAULT: '#2563eb',
              dark: '#1d4ed8'
            }
          },
          boxShadow: {
            soft: '0 10px 25px -10px rgba(0,0,0,.25)'
          }
        }
      }
    }
  </script>


  <style>
    :root{
      --border:rgba(148,163,184,.35);
      --bg-primary: #fff;
      --bg-secondary: #f8fafc;
      --bg-card: #fff;
    }
    .dark {
      --border:rgba(148,163,184,.25);
      --bg-primary: #0b1220;
      --bg-secondary: #131b2b;
      --bg-card: #0b1220;
    }

    *{outline:0}
    .input{border:1px solid var(--border);border-radius:12px;padding:.65rem .8rem;background:var(--bg-primary);color:var(--text-primary);transition:all .2s}
    .dark .input{background:#0b1220;color:#f8fafc;border-color:rgba(148,163,184,.25)}
    .input:focus{box-shadow:0 0 0 3px rgba(37,99,235,.2);border-color:#2563eb}
    .btn-primary{background:#2563eb;color:#fff;border-radius:12px;padding:.65rem .95rem;font-weight:800;transition:transform .05s ease;box-shadow:0 10px 25px -10px rgba(37,99,235,.6)}
    .btn-primary:hover{background:#1d4ed8}
    .btn-primary:active{transform:translateY(1px)}
    .btn-secondary{background:#e2e8f0;border:1px solid var(--border);border-radius:12px;padding:.6rem .9rem;font-weight:700}
    .dark .btn-secondary{background:#0b1220}
    .btn-danger{background:#ef4444;color:#fff;border-radius:12px;padding:.6rem .9rem;font-weight:800}
    .btn-ghost{border:1px solid var(--border);border-radius:12px;padding:.5rem .8rem;font-weight:700;background:transparent}
    .btn-icon{border:1px solid var(--border);border-radius:12px;padding: .5rem; font-weight:700;background:transparent;line-height:1; min-width: 38px; text-align: center;}
    .btn-icon:hover, .btn-ghost:hover { background-color: rgba(148,163,184,.1); }
    .dark .btn-icon:hover, .dark .btn-ghost:hover { background-color: rgba(148,163,184,.2); }
    
    .card{border:1px solid var(--border);background:var(--bg-card);border-radius:16px;padding:1rem 1rem 1.25rem 1rem;box-shadow:0 10px 25px -12px rgba(0,0,0,.25)}
    .dark .card{background:#0b1220}
    
    .section-title{font-weight:800}
    .badge{background:#fde68a;color:#78350f;border-radius:9999px;padding:.1rem .55rem;font-size:.75rem;font-weight:800}
    .field>label{display:block;font-size:.85rem;opacity:.8;margin-bottom:.25rem}
    .tab-btn{border:1px solid var(--border);border-radius:10px;padding:.55rem .7rem;text-align:left;font-weight:800;background:transparent; display: flex; align-items: center; position: relative;}
    .tab-btn.active{background:#2563eb;color:#fff;border-color:#2563eb}
        
    #toast{background:#111827;color:#fff;border-radius:9999px;padding:.6rem 1rem;font-weight:800;box-shadow:0 10px 25px -12px rgba(0,0,0,.35)}
    
    .pending-item, .approved-item { cursor: grab; }
    .pending-item:active, .approved-item:active { cursor: grabbing; }
    .dragging { opacity: 0.5; }
    .drag-over-top { border-top: 2px dashed #2563eb !important; }
    .drag-over-bottom { border-bottom: 2px dashed #2563eb !important; }

    .pending-item{border-left:4px solid #f59e0b;background:#fffbeb;border-radius:12px;padding:.7rem .75rem;display:flex;align-items:center;justify-content:space-between;gap:.75rem}
    .approved-item{border-left:4px solid #22c55e;background:#ecfdf5;border-radius:12px;padding:.7rem .75rem;display:flex;align-items:center;justify-content:space-between;gap:.75rem}
    .dark .pending-item{background:#0f172a}
    .dark .approved-item{background:#052e1a}
    .hidden{display:none}
    #modal-overlay.flex { display: flex; }

    /* Estilos de Alarme */
    @keyframes pulse-red {
      0%, 100% { background-color: #ef4444; color: white; }
      50% { background-color: #f87171; color: white; }
    }
    .alarm-level-1 { background-color: #fef3c7; }
    .dark .alarm-level-1 { background-color: #422006; }
    .alarm-level-2 { background-color: #fde68a; }
    .dark .alarm-level-2 { background-color: #78350f; }
    .alarm-level-3 { background-color: #fca5a5; }
    .dark .alarm-level-3 { background-color: #7f1d1d; }
    .alarm-level-4 { 
      animation: pulse-red 1.5s infinite; 
      border-color: #b91c1c;
    }
    .dark .alarm-level-4 { 
      animation: pulse-red 1.5s infinite; 
      border-color: #ef4444;
    }
  </style>

</head>
<body class="font-inter bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-100 transition-colors duration-300">

  <div id="login-overlay" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white dark:bg-slate-800 shadow-soft p-6">
      <div class="flex items-center gap-3 mb-4">
        <h2 class="text-xl font-extrabold">Acesso</h2>
      </div>
      <p class="text-sm opacity-80 mb-4">Entre com usu√°rio e PIN.</p>
      <div class="grid gap-3">
        <input id="login-user" class="input" placeholder="Usu√°rio">
        <input id="login-pin" class="input" placeholder="PIN" type="password" inputmode="numeric">
        <button id="login-btn" class="btn-primary">Entrar</button>
      </div>
      <p id="login-msg" class="mt-3 text-sm text-red-500 hidden"></p>
    </div>
  </div>

  <div id="modal-overlay" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white dark:bg-slate-800 shadow-soft p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 id="modal-title" class="text-xl font-extrabold">Editar</h2>
        <button id="modal-close" class="btn-icon">‚úñ</button>
      </div>
      <div id="modal-content" class="grid gap-3">
        </div>
      <div class="mt-4 flex gap-2">
        <button id="modal-save" class="btn-primary flex-1">Salvar</button>
        <button id="modal-cancel" class="btn-secondary flex-1">Cancelar</button>
      </div>
    </div>
  </div>


  <div id="app" class="opacity-0">
    <header class="sticky top-0 z-40 backdrop-blur bg-white/70 dark:bg-slate-900/70 border-b border-slate-200/60 dark:border-slate-700/60">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <h1 class="text-lg sm:text-2xl font-black">Lista de Sa√≠das<span class="text-slate-400"></span></h1>
        </div>
        <div class="flex items-center gap-2">
          <span id="clock" class="hidden sm:inline font-mono text-sm opacity-80"></span>
          <button id="logout-btn" class="btn-ghost">Sair</button>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-6 grid md:grid-cols-[280px,1fr] gap-6">
      <aside class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-4 space-y-4 h-fit md:sticky md:top-20">
        <h3 class="text-base font-extrabold">Navega√ß√£o</h3>
        <nav class="grid gap-2">
          <button class="tab-btn active" data-tab="saidas">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
            Controle de Sa√≠das
          </button>
                    
          <button class="tab-btn" data-tab="s5">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13z" clip-rule="evenodd" /></svg>
            Gest√£o 5S
          </button>
          <button class="tab-btn" data-tab="config">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.835 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.835 2.942-.734 2.106-2.106a1.533 1.533 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.835-1.372-.734-2.942-2.106-2.106A1.532 1.532 0 0111.49 3.17zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
            Configura√ß√µes
          </button>
        </nav>

        <div class="rounded-xl bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300 p-3 text-sm">
          <b>Status:</b> <span id="status-conn">Conectado</span> <span class="opacity-70">(Nuvem)</span>
        </div>

        <div>
          <button id="ddm-header" class="w-full flex items-center justify-between rounded-xl bg-slate-50 dark:bg-slate-700/40 px-3 py-2 text-sm font-bold">
            Gerenciar Dados <span class="transition-transform" id="ddm-caret">‚ñº</span>
          </button>
          <div id="ddm" class="mt-3 grid gap-2 hidden"> <button id="btn-backup-download" class="btn-secondary">Baixar Backup Completo (.json)</button>
            <label class="btn-secondary cursor-pointer text-center">
              <input id="file-backup" type="file" accept="application/json" class="hidden">
              Carregar Backup Completo (.json)
            </label>
            <button id="btn-reset" class="btn-danger">Resetar TUDO (Nuvem)</button>
          </div>
        </div>
      </aside>

      <section class="space-y-6">
        <div id="tab-saidas" class="card">
          <div class="flex items-center justify-between gap-4">
            <div>
              <h2 class="text-xl font-bold">Painel de Controle</h2>
              <p class="text-sm opacity-70">Hor√°rio de Bras√≠lia</p>
            </div>
            <div id="alarm-pill" class="px-3 py-1 rounded-full text-xs font-black bg-emerald-200 text-emerald-800 dark:bg-emerald-800 dark:text-emerald-200 cursor-pointer transition-colors" title="Clique para ligar/desligar o alarme sonoro">ALARME: LIGADO</div>
          </div>

          <div class="mt-6">
            <h3 class="section-title">Adicionar Aluno √† Fila de Espera</h3>
            <div class="flex gap-2">
              <input id="input-name" class="input flex-1" placeholder="Nome completo do aluno (ex: Allanna Leite Teixeira)">
              <button id="btn-add" class="btn-primary">Adicionar √† Fila</button>
            </div>
          </div>

          <div class="mt-8">
            <div class="flex items-center justify-between">
              <h3 class="section-title">Fila de Sa√≠da & Retorno <span id="pending-count" class="badge">0</span></h3>
              <input id="hist-search" class="input w-56" placeholder="üîé Filtrar hist√≥rico...">
            </div>
            <ul id="pending-list" class="mt-3 grid gap-3"></ul>
          </div>

          <div class="mt-8">
            <h3 class="section-title">Hist√≥rico</h3>
            <div id="history" class="mt-3 grid gap-2"></div>
          </div>
        </div>

        <div id="tab-s5" class="card hidden">
          <h2 class="text-xl font-bold mb-4 text-center">Gest√£o de Qualidade 5S</h2>
          <div class="grid sm:grid-cols-2 gap-3">
            <input id="s5-p1" class="input" placeholder="Pessoa 1">
            <input id="s5-p2" class="input" placeholder="Pessoa 2">
            <input id="s5-p3" class="input" placeholder="Pessoa 3">
            <input id="s5-p4" class="input" placeholder="Pessoa 4">
            <select id="s5-shift" class="input"><option>Manh√£</option><option>Tarde</option><option>Noite</option></select>
            <button id="s5-add" class="btn-primary sm:col-span-2">Adicionar Equipe</button>
          </div>
          <ul id="s5-list" class="mt-6 grid gap-2"></ul>
        </div>

        <div id="tab-config" class="card hidden">
          <h2 class="text-xl font-bold mb-4 text-center">Configura√ß√µes</h2>
          <div class="grid sm:grid-cols-2 gap-4">
            <div class="field">
              <label>1¬∫ Alerta (min)</label><input id="al1" type="number" class="input" min="1">
            </div>
            <div class="field">
              <label>2¬∫ Alerta (min)</label><input id="al2" type="number" class="input" min="1">
            </div>
            <div class="field">
              <label>3¬∫ Alerta (min)</label><input id="al3" type="number" class="input" min="1">
            </div>
            <div class="field">
              <label>4¬∫ Alerta (min)</label><input id="al4" type="number" class="input" min="1">
            </div>
            <div class="field sm:col-span-2">
              <label>Alarme Cont√≠nuo (min)</label><input id="alP" type="number" class="input" min="1">
            </div>
            <div class="field sm:col-span-2">
              <label>Motivo Padr√£o</label><input id="def-reason" class="input">
            </div>
            <button id="btn-save-settings" class="btn-primary sm:col-span-2">Salvar Configura√ß√µes</button>
          </div>
        </div>
      </section>
    </main>

    <div id="toast" class="fixed bottom-4 right-4 hidden"></div>

    <!-- Bot√£o Flutuante (FAB) do Link -->
    <a id="fab-form-link" 
       href="https://forms.gle/HJLqG9VJWkmg3c9R6" 
       target="_blank" 
       rel="noopener noreferrer"
       class="fixed bottom-6 right-6 z-40 btn-primary rounded-full p-4 shadow-lg"
       title="Abrir Formul√°rio de Feedback">
      <!-- √çcone de "Formul√°rio" (Clipboard List) -->
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
      </svg>
    </a>
  </div>

  <script>
    // Reveal after JS initialization starts
    window.addEventListener('load', () => {
      document.documentElement.style.opacity = "1";
      document.getElementById('app').classList.remove('opacity-0');
    });
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, push, update, remove, off, onDisconnect } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    /* ========================== Firebase init ========================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBl8K0WVSDtGsgJygr3yCSsQ_voywnm114",
      authDomain: "gerenciador-saidas-5s-e4c58.firebaseapp.com",
      databaseURL: "https://gerenciador-saidas-5s-e4c58-default-rtdb.firebaseio.com",
      projectId: "gerenciador-saidas-5s-e4c58",
      storageBucket: "gerenciador-saidas-5s-e4c58.firebasestorage.app",
      messagingSenderId: "990056306037",
      appId: "1:990056306037:web:7bb1f8b8247631acb3af3c",
      measurementId: "G-0ZFEQRYPQT"
    };

    let app, db;
    app = initializeApp(firebaseConfig);
    db = getDatabase(app);
    
    /* ========================== State ========================== */
    const state = {
      session: null,
      settings: {
        alertLevels: [6,10,15,20],
        persistentAlarmMinutes: 25,
        defaultReason: "Banheiro"
      },
      requests: [], // AGORA SER√Å A LISTA COMBINADA
      s5Teams: [],
      
      audioInitialized: false, 
      audioCtx: null, 
      alarmOn: true, 
      alarmingStudents: new Set(),
      alarmLevelsCache: {},
      timers: { clock:null, alert:null },
      editingItemId: null,
    };
    
    // NOVO: Estados separados para a fila e hist√≥rico
    let filaAtivaState = [];
    let historicoState = [];

    /* ========================== Utils ========================== */
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => [...document.querySelectorAll(sel)];
    const fmtDur = (ms)=>{
      if (isNaN(ms) || ms < 0) return "0m 0s";
      const s = Math.floor(ms/1000);
      return `${Math.floor(s/60)}m ${s%60}s`;
    };
    const cleanName = (n)=> (n||"").trim().toLowerCase().split(" ").filter(Boolean).map(w=>w[0].toUpperCase()+w.slice(1)).join(" ");
    
    const formatDateTimeLocal = (isoString) => {
      if (!isoString) return '';
      const date = new Date(isoString);
      date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
      return date.toISOString().slice(0, 16);
    };

    const parseDateTimeLocal = (dateTimeLocalString) => {
        if (!dateTimeLocalString) return '';
        const date = new Date(dateTimeLocalString);
        return date.toISOString();
    };

    function toast(msg, kind="info"){
      const box = $("#toast");
      box.textContent = msg;
      box.classList.remove("hidden");
      box.style.background = kind==="error" ? "#ef4444" : (kind==="ok" ? "#065f46" : "#111827");
      setTimeout(()=>box.classList.add("hidden"), 3000);
    }

    /* ========================== Audio ========================== */
    function initAudio() {
      if (state.audioInitialized) return;
      try {
        state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        state.audioInitialized = true;
        console.log("AudioContext inicializado.");
      } catch (e) {
        console.error("AudioContext n√£o suportado.", e);
        toast("√Åudio n√£o p√¥de ser inicializado.", "error");
      }
    }

    function playBeep() {
      if (!state.audioCtx || !state.alarmOn) return;
      try {
        const oscillator = state.audioCtx.createOscillator();
        const gainNode = state.audioCtx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(state.audioCtx.destination);
        
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(1000, state.audioCtx.currentTime); 
        gainNode.gain.setValueAtTime(0.5, state.audioCtx.currentTime);
        
        oscillator.start(state.audioCtx.currentTime);
        oscillator.stop(state.audioCtx.currentTime + 0.2);
      } catch (e) {
        console.error("Falha ao tocar bipe:", e);
      }
    }
    
    /* ========================== Modal Gen√©rico ========================== */
    const $modalOverlay = $("#modal-overlay");
    const $modalTitle = $("#modal-title");
    const $modalContent = $("#modal-content");
    const $modalSave = $("#modal-save");
    const $modalCancel = $("#modal-cancel");
    const $modalClose = $("#modal-close");

    let onModalSave = () => {};
    let onModalCancel = () => {};

    function openModal(title, contentHtml, saveCallback, cancelCallback = () => {}) {
      $modalTitle.textContent = title;
      $modalContent.innerHTML = contentHtml;
      onModalSave = saveCallback;
      onModalCancel = cancelCallback;
      $modalSave.textContent = "Salvar";
      $modalCancel.textContent = "Cancelar";
      $modalOverlay.classList.remove("hidden");
      $modalOverlay.classList.add("flex");
    }

    function closeModal() {
      $modalOverlay.classList.add("hidden");
      $modalOverlay.classList.remove("flex");
      $modalContent.innerHTML = "";
      state.editingItemId = null;
      onModalSave = () => {};
      onModalCancel = () => {};
    }

    $modalSave.addEventListener("click", () => onModalSave());
    $modalCancel.addEventListener("click", closeModal);
    $modalClose.addEventListener("click", closeModal);

    function openConfirmModal(text, callback) {
      $modalTitle.textContent = "Confirma√ß√£o";
      $modalContent.innerHTML = `<p>${text}</p>`;
      $modalSave.textContent = "Confirmar";
      $modalCancel.textContent = "Cancelar";
      
      onModalSave = () => {
        closeModal();
        callback(true);
      };
      
      onModalCancel = () => {
        closeModal();
        callback(false);
      };

      $modalOverlay.classList.remove("hidden");
      $modalOverlay.classList.add("flex");
    }
    
    function confirmBox(text) {
      return new Promise((resolve) => {
        openConfirmModal(text, (ok) => {
          resolve(ok);
        });
      });
    }

    /* ========================== Login / Logout ========================== */
    const USERS = { "ezequiel": "Gois", "larissa":"7524" };

    function showLogin(show){
      $("#login-overlay").classList.toggle("hidden", !show);
      $("#login-overlay").classList.toggle("flex", show);
      if (show) $("#login-user").focus();
    }

    function tryAutoLogin(){
      try {
        const raw = localStorage.getItem("sessionUser");
        if (!raw) return false;
        const sess = JSON.parse(raw);
        if (!sess || !USERS[sess.user]) return false;
        state.session = sess;
        return true;
      } catch(e){ return false; }
    }

    function login(user, pin){
      user = (user||"").trim().toLowerCase();
      pin = (pin||"").trim();
      if (USERS[user] && USERS[user] === pin){
        state.session = { user, ts: Date.now() };
        localStorage.setItem("sessionUser", JSON.stringify(state.session));
        
        showLogin(false);
        toast("Bem-vindo!", "ok");
        return true;
      }
      $("#login-msg").classList.remove("hidden");
      $("#login-msg").textContent = "Usu√°rio ou PIN inv√°lidos.";
      return false;
    }

    function logout(){
      localStorage.removeItem("sessionUser");
      state.session = null;
      showLogin(true);
    }

    /* ========================== Data bindings ========================== */
    function bindRealtime(){
      onValue(ref(db, "settings"), (snap)=>{
        const s = snap.val();
        if (s) state.settings = {...state.settings, ...s};
        $("#al1").value = state.settings.alertLevels[0];
        $("#al2").value = state.settings.alertLevels[1];
        $("#al3").value = state.settings.alertLevels[2];
        $("#al4").value = state.settings.alertLevels[3];
        $("#alP").value = state.settings.persistentAlarmMinutes;
        $("#def-reason").value = state.settings.defaultReason || "";
      });

      // Este agora s√≥ ouve a FILA ATIVA (MUITO LEVE)
      onValue(ref(db, "saidas"), (snap)=>{
        const data = snap.val() || {};
        filaAtivaState = Object.entries(data).map(([id, v])=> ({id, ...v}));
        
        // Combina com o hist√≥rico que j√° temos no state
        state.requests = [...filaAtivaState, ...historicoState];
        renderSaidas();
      });

      // NOVO: Ouvinte APENAS para o hist√≥rico
      onValue(ref(db, "historicoSaidas"), (snap)=>{
        const data = snap.val() || {};
        historicoState = Object.entries(data).map(([id, v])=> ({id, ...v}));
        
        // Combina com a fila ativa que j√° temos no state
        state.requests = [...filaAtivaState, ...historicoState];
        renderSaidas();
      });

      onValue(ref(db, "s5Teams"), (snap)=>{
        const data = snap.val() || {};
        state.s5Teams = Object.entries(data).map(([id, v])=> ({id, ...v}));
        renderS5();
      });
    }

    /* ========================== Render Sa√≠das ========================== */
    function renderSaidas(){
      const pendingAll = state.requests.filter(r => r.status==="pending" || r.status==="approved");
      
      pendingAll.sort((a, b) => {
          const orderA = a.order !== undefined ? a.order : new Date(a.requestTime).getTime();
          const orderB = b.order !== undefined ? b.order : new Date(a.requestTime).getTime();
          return orderA - orderB;
      });

      const history = state.requests.filter(r => r.status==="completed" || r.status==="rejected");
      $("#pending-count").textContent = pendingAll.length.toString();

      const pList = $("#pending-list");
      pList.innerHTML = "";
      if(pendingAll.length===0){
        pList.innerHTML = `<li class="text-sm opacity-70 italic">Ningu√©m na fila agora.</li>`;
      }
      const now = Date.now();

      pendingAll.forEach(req => {
        const isApproved = req.status === "approved";
        const li = document.createElement("li");
        li.className = isApproved ? "approved-item" : "pending-item";
        li.dataset.liId = req.id;
        li.draggable = true;
        li.dataset.dragId = req.id;

        const timeStr = new Date(isApproved?req.departureTime:req.requestTime||Date.now()).toLocaleTimeString("pt-BR");
        const left = document.createElement("div");
        
        const reason = req.reason || (isApproved ? (state.settings.defaultReason || "Banheiro") : "N/A");
        left.innerHTML = `<b>${req.userName}</b> <span class="text-xs opacity-60 ml-1">(${timeStr})</span>
                          <div class="text-xs mt-0.5">` +
                          (isApproved ? `Motivo: ${reason} | Decorrido: <span data-dur="${req.id}-out">${fmtDur(now - new Date(req.departureTime))}</span>`
                                      : `Espera: <span data-dur="${req.id}-wait">${fmtDur(now - new Date(req.requestTime))}</span>`)
                        + `</div>`;
        
        const right = document.createElement("div");
        right.className = "flex items-center gap-2";
        
        if (!isApproved){
          right.innerHTML = `<button class="btn-primary" data-act="approve" data-id="${req.id}">Liberar</button>
                             <button class="btn-danger" data-act="reject" data-id="${req.id}">Recusar</button>`;
        } else {
          right.innerHTML = `<button class="btn-secondary" data-act="return" data-id="${req.id}">Chegou</button>`;
        }
        right.innerHTML += `<button class="btn-icon" data-act="edit-saida" data-id="${req.id}">‚úèÔ∏è</button>
                            <button class="btn-icon" data-act="del-saida" data-id="${req.id}">üóë</button>`;

        li.append(left, right);
        pList.appendChild(li);
      });

      const histBox = $("#history");
      histBox.innerHTML = "";
      const query = ($("#hist-search").value||"").toLowerCase();
      const byDay = {};
      history.forEach(r=>{
        if (query && !r.userName.toLowerCase().includes(query)) return;
        const d = new Date(r.requestTime||r.departureTime||Date.now());
        const key = d.toLocaleDateString("pt-BR");
        (byDay[key] ||= []).push(r);
      });
      const days = Object.keys(byDay).sort((a,b)=>{
        const da = new Date(a.split("/").reverse().join("-"));
        const db = new Date(b.split("/").reverse().join("-"));
        return db-da;
      });
      if (days.length===0){
        histBox.innerHTML = `<div class="text-sm opacity-70 italic">Hist√≥rico vazio.</div>`;
      }
      days.forEach(day=>{
        const hdr = document.createElement("div");
        hdr.className = "rounded-xl bg-indigo-100 dark:bg-indigo-900/30 text-indigo-800 dark:text-indigo-200 px-3 py-2 font-extrabold flex items-center justify-between cursor-pointer";
        hdr.textContent = day;
        hdr.dataset.day = day; 
        const caret = document.createElement("span"); caret.textContent = "‚ñº"; caret.className = "transition-transform"; hdr.append(caret);
        const list = document.createElement("ul"); list.className="grid gap-1 bg-white dark:bg-slate-800 rounded-b-xl p-2 hidden"; // Come√ßa escondido

        byDay[day].sort((a,b)=>(new Date(b.requestTime||b.departureTime))-(new Date(a.requestTime||a.departureTime))).forEach(r=>{
          const li = document.createElement("li");
          li.className = "flex items-center justify-between border-b border-slate-200/60 dark:border-slate-700/40 py-1";
          const t1 = r.requestTime ? new Date(r.requestTime).toLocaleTimeString("pt-BR") : "";
          const t_dep = r.departureTime ? new Date(r.departureTime).toLocaleTimeString("pt-BR") : "";
          const t_ret = r.returnTime ? new Date(r.returnTime).toLocaleTimeString("pt-BR") : "";
          
          const status = r.status==="completed" ? "Liberado" : (r.status === "rejected" ? "Recusado" : "Pendente");
          const dur = (r.returnTime && r.departureTime) ? ` (${fmtDur(new Date(r.returnTime)-new Date(r.departureTime))})` : "";
          const reason = r.reason || (r.status === 'completed' ? (state.settings.defaultReason || 'Banheiro') : (r.status === 'rejected' ? 'Recusado/Cancelado' : 'N/A'));

          li.innerHTML = `<div class="min-w-0 truncate">
                            <b>${r.userName}</b> ‚Äî <span class="${r.status==='completed'?'text-emerald-600':'text-rose-600'} font-bold">${status}</span>
                            <br><span class="text-xs opacity-70">Solicitado: ${t1} ${r.departureTime ? `| Sa√≠da: ${t_dep}` : ''} ${r.returnTime ? `| Retorno: ${t_ret}` : ''} ${dur}</span>
                            <br><span class="text-xs opacity-80">Motivo: ${reason}</span>
                          </div>
                          <div class="flex gap-1">
                            <button class="btn-icon" data-act="edit-saida" data-id="${r.id}">‚úèÔ∏è</button>
                            <button class="btn-icon" data-act="del-saida" data-id="${r.id}">üóë</button>
                          </div>`;
          list.appendChild(li);
        });
        histBox.append(hdr, list);
      });
    }

    /* ========================== Render S5 ========================== */
    function renderS5(){
      const ul = $("#s5-list");
      ul.innerHTML = "";
      if (state.s5Teams.length===0){
        ul.innerHTML = `<li class="text-sm opacity-70 italic">Nenhuma equipe 5S registrada.</li>`;
        return;
      }
      state.s5Teams.forEach(team=>{
        const li = document.createElement("li");
        li.className = `flex items-center justify-between rounded-xl p-3 border ${team.isCompleted?'bg-emerald-50 border-emerald-400':'bg-rose-50 border-rose-400'} dark:border-transparent dark:${team.isCompleted?'bg-emerald-900/20':'bg-rose-900/20'}`;
        const list = [team.person1,team.person2,team.person3,team.person4].filter(Boolean).join(", ");
        const label = document.createElement("div");
        const reg = new Date(team.registrationTime||Date.now()).toLocaleDateString("pt-BR");
        label.innerHTML = `<div class="font-extrabold">${reg} ‚Äî ${team.shift}</div><div class="text-sm opacity-80">${list}</div>`;
        
        const right = document.createElement("div");
        right.className = "flex items-center gap-2";
        
        const chk = document.createElement("input");
        chk.type = "checkbox"; chk.checked = !!team.isCompleted;
        chk.addEventListener("change", ()=> update(ref(db, "s5Teams/"+team.id), { isCompleted: chk.checked }));
        
        const editBtn = document.createElement("button");
        editBtn.className = "btn-icon";
        editBtn.textContent = "‚úèÔ∏è";
        editBtn.dataset.act = "edit-s5";
        editBtn.dataset.id = team.id;
        
        const delBtn = document.createElement("button");
        delBtn.className = "btn-icon";
        delBtn.textContent = "üóë";
        delBtn.dataset.act = "del-s5";
        delBtn.dataset.id = team.id;

        right.append(chk, editBtn, delBtn);
        li.append(label,right);
        ul.appendChild(li);
      });
    }

    /* ========================== Actions (Sa√≠das) ========================== */
    function addStudent(){
      const name = cleanName($("#input-name").value);
      if (!name) return toast("Digite o nome do aluno.", "error");
      
      const payload = {
        userName: name,
        status: "pending",
        requestTime: new Date().toISOString(),
        order: Date.now() 
      };

      push(ref(db, "saidas"), payload).then(()=>{
        $("#input-name").value = "";
        toast(`"${name}" adicionado √† fila.`, "ok");
      });
    }

    function updateQueueOrder() {
        const updates = {};
        const items = $$("#pending-list li[data-drag-id]");
        
        items.forEach((li, index) => {
            const id = li.dataset.dragId;
            if (id) {
                updates[`saidas/${id}/order`] = index;
            }
        });

        if (Object.keys(updates).length > 0) {
            update(ref(db), updates).then(() => {
                toast("Ordem da fila atualizada.", "ok");
            }).catch(err => {
                toast("Erro ao salvar ordem.", "error");
                renderSaidas();
            });
        }
    }

    function approve(id){
      // Esta fun√ß√£o permanece igual, pois apenas atualiza um item *dentro* da fila ativa
      update(ref(db, "saidas/"+id), {
        status: "approved",
        departureTime: new Date().toISOString(),
        reason: state.settings.defaultReason || "Banheiro"
      });
    }
    
    // === VERS√ÉO NOVA (Move para o hist√≥rico) ===
    async function reject(id) {
      // 1. Encontra o registro na fila ativa
      const req = filaAtivaState.find(r => r.id === id); 
      if (!req) return toast("Registro n√£o encontrado", "error");

      // 2. Prepara o registro final para o hist√≥rico
      const historicoEntry = {
        ...req,
        status: "rejected",
        returnTime: new Date().toISOString(),
        reason: "Recusado/Cancelado"
      };

      // 3. Cria o objeto de m√∫ltiplas escritas
      const updates = {};
      updates[`historicoSaidas/${id}`] = historicoEntry; // Adiciona ao hist√≥rico
      updates[`saidas/${id}`] = null; // Remove da fila ativa

      // 4. Executa
      try {
        await update(ref(db), updates);
        toast("Pedido movido para o hist√≥rico.", "ok");
      } catch (e) {
        toast("Erro ao mover pedido.", "error");
      }
    }
    
    // === VERS√ÉO NOVA (Move para o hist√≥rico) ===
    async function arrived(id) {
      // 1. Encontra o registro na fila ativa
      const req = filaAtivaState.find(r => r.id === id); 
      if (!req) return toast("Registro n√£o encontrado", "error");

      // 2. Prepara o registro final para o hist√≥rico
      const historicoEntry = {
        ...req, // Pega todos os dados existentes (nome, hora, etc.)
        status: "completed",
        returnTime: new Date().toISOString()
      };

      // 3. Cria um objeto de "m√∫ltiplas escritas"
      const updates = {};
      updates[`historicoSaidas/${id}`] = historicoEntry; // Adiciona ao hist√≥rico
      updates[`saidas/${id}`] = null; // Remove da fila ativa

      // 4. Executa as duas opera√ß√µes de uma vez
      try {
        await update(ref(db), updates);
        toast("Aluno movido para o hist√≥rico.", "ok");
      } catch (e) {
        toast("Erro ao mover aluno.", "error");
      }
      
      // Limpeza imediata do alarme (l√≥gica anterior mantida)
      if (state.alarmingStudents.has(id)) {
        console.log(`Limpando alarme (imediato) para ${id}`);
        state.alarmingStudents.delete(id);
      }
      if (state.alarmLevelsCache[id]) {
        delete state.alarmLevelsCache[id];
      }
    }
    
    // === CORRE√á√ÉO: removeReq agora precisa saber de ONDE apagar ===
    async function removeReq(id){
      const ok = await confirmBox("Tem certeza que deseja excluir este registro de sa√≠da PERMANENTEMENTE?");
      if (!ok) return;
      
      // 1. Descobrir se o item est√° na fila ativa ou no hist√≥rico
      const req = state.requests.find(r => r.id === id);
      let path = `saidas/${id}`; // Padr√£o √© a fila ativa
      if (req && (req.status === 'completed' || req.status === 'rejected')) {
        path = `historicoSaidas/${id}`; // Se completo/rejeitado, est√° no hist√≥rico
      }

      // 2. Apagar do n√≥ correto
      remove(ref(db, path)).then(() => {
        toast("Registro exclu√≠do.", "ok");
      }).catch(err => {
        toast("Erro ao excluir.", "error");
      });
    }

    function openEditSaidaModal(id) {
      const req = state.requests.find(r => r.id === id);
      if (!req) return toast("Registro n√£o encontrado.", "error");

      state.editingItemId = id;
      const currentReason = req.reason || (req.status === 'approved' || req.status === 'completed' ? (state.settings.defaultReason || 'Banheiro') : '');
      
      const requestTimeLocal = formatDateTimeLocal(req.requestTime);
      const departureTimeLocal = formatDateTimeLocal(req.departureTime);
      const returnTimeLocal = formatDateTimeLocal(req.returnTime);

      const content = `
        <div class="field">
          <label>Nome do Aluno</label>
          <input id="edit-saida-name" class="input" value="${req.userName}">
        </div>
        <div class="field">
          <label>Motivo</label>
          <input id="edit-saida-reason" class="input" value="${req.reason || ''}" placeholder="Motivo da sa√≠da">
        </div>
        <div class="field">
          <label>Hora de Solicita√ß√£o</label>
          <input id="edit-request-time" type="datetime-local" class="input" value="${requestTimeLocal}">
        </div>
        <div class="field">
          <label>Hora de Sa√≠da</label>
          <input id="edit-departure-time" type="datetime-local" class="input" value="${departureTimeLocal}">
        </div>
        <div class="field">
          <label>Hora de Retorno</label>
          <input id="edit-return-time" type="datetime-local" class="input" value="${returnTimeLocal}">
        </div>
      `;
      openModal("Editar Sa√≠da", content, () => saveSaida(id));
    }

    // === CORRE√á√ÉO: saveSaida agora precisa saber para ONDE salvar/mover ===
    async function saveSaida(id) {
      const name = cleanName($("#edit-saida-name").value);
      const reason = ($("#edit-saida-reason").value || "").trim();
      const requestTime = parseDateTimeLocal($("#edit-request-time").value);
      const departureTime = parseDateTimeLocal($("#edit-departure-time").value);
      const returnTime = parseDateTimeLocal($("#edit-return-time").value);

      if (!name) return toast("O nome n√£o pode ficar em branco.", "error");

      // 1. Montar o objeto de dados atualizado
      const updatesPayload = {
        userName: name,
        reason: reason || (state.settings.defaultReason || "Banheiro"),
        requestTime: requestTime,
        departureTime: departureTime,
        returnTime: returnTime,
      };

      if (!requestTime) updatesPayload.requestTime = null;
      if (!departureTime) updatesPayload.departureTime = null;
      if (!returnTime) updatesPayload.returnTime = null;
      
      const currentReq = state.requests.find(r => r.id === id);
      if (!currentReq) return toast("Erro: Registro original n√£o encontrado.", "error");

      if (updatesPayload.returnTime) {
          updatesPayload.status = "completed";
      } else if (updatesPayload.departureTime) {
          updatesPayload.status = "approved";
      } else {
          updatesPayload.status = "pending";
      }
      if (currentReq.status === 'rejected' && !updatesPayload.departureTime && !updatesPayload.returnTime) {
          updatesPayload.status = "rejected";
      }
      
      // 2. Descobrir onde o registo *estava* e para onde *vai*
      const wasInHistory = currentReq && (currentReq.status === 'completed' || currentReq.status === 'rejected');
      const newStatus = updatesPayload.status;
      const willBeInHistory = (newStatus === 'completed' || newStatus === 'rejected');

      // 3. Preparar a atualiza√ß√£o at√≥mica
      const updates = {};
      
      if (wasInHistory && !willBeInHistory) {
          // Mover: Hist√≥rico -> Fila Ativa
          updates[`historicoSaidas/${id}`] = null;
          updates[`saidas/${id}`] = {...currentReq, ...updatesPayload}; // Mescla dados para n√£o perder 'order' etc.
      } else if (!wasInHistory && willBeInHistory) {
          // Mover: Fila Ativa -> Hist√≥rico
          updates[`saidas/${id}`] = null;
          updates[`historicoSaidas/${id}`] = {...currentReq, ...updatesPayload};
      } else if (wasInHistory) {
          // Atualizar no lugar: Hist√≥rico -> Hist√≥rico
          updates[`historicoSaidas/${id}`] = {...currentReq, ...updatesPayload};
      } else {
          // Atualizar no lugar: Fila Ativa -> Fila Ativa
          updates[`saidas/${id}`] = {...currentReq, ...updatesPayload};
      }

      // 4. Executar
      try {
        await update(ref(db), updates);
        toast("Registro atualizado!", "ok");
        closeModal();
      } catch (e) {
        toast("Erro ao atualizar.", "error");
        console.error("Falha ao salvar:", e, updates);
      }
    }

    /* ========================== Actions (S5) ========================== */
    function addS5Team() {
      const p = ["#s5-p1", "#s5-p2", "#s5-p3", "#s5-p4"].map(sel => cleanName($(sel).value));
      const payload = {
        person1: p[0] || "Vago",
        person2: p[1] || "Vago",
        person3: p[2] || "Vago",
        person4: p[3] || "Vago",
        shift: $("#s5-shift").value,
        isCompleted: false,
        registrationTime: new Date().toISOString()
      };
      push(ref(db, "s5Teams"), payload).then(() => {
        ["#s5-p1", "#s5-p2", "#s5-p3", "#s5-p4"].forEach(sel => $(sel).value = "");
        toast("Equipe adicionada.", "ok");
      });
    }

    async function removeS5Team(id) {
      const ok = await confirmBox("Tem certeza que deseja excluir esta equipe 5S?");
      if (!ok) return;
      remove(ref(db, "s5Teams/" + id));
      toast("Equipe exclu√≠da.", "ok");
    }

    function openEditS5Modal(id) {
      const team = state.s5Teams.find(t => t.id === id);
      if (!team) return toast("Equipe n√£o encontrada.", "error");

      state.editingItemId = id;
      const content = `
        <div class="field">
          <label>Pessoa 1</label>
          <input id="edit-s5-p1" class="input" value="${team.person1 || ''}">
        </div>
        <div class="field">
          <label>Pessoa 2</label>
          <input id="edit-s5-p2" class="input" value="${team.person2 || ''}">
        </div>
        <div class="field">
          <label>Pessoa 3</label>
          <input id="edit-s5-p3" class="input" value="${team.person3 || ''}">
        </div>
        <div class="field">
          <label>Pessoa 4</label>
          <input id="edit-s5-p4" class="input" value="${team.person4 || ''}">
        </div>
        <div class="field">
          <label>Turno</label>
          <select id="edit-s5-shift" class="input">
            <option ${team.shift === 'Manh√£' ? 'selected' : ''}>Manh√£</option>
            <option ${team.shift === 'Tarde' ? 'selected' : ''}>Tarde</option>
            <option ${team.shift === 'Noite' ? 'selected' : ''}>Noite</option>
          </select>
        </div>
      `;
      openModal("Editar Equipe 5S", content, () => saveS5Team(id));
    }

    function saveS5Team(id) {
      const p = ["#edit-s5-p1", "#edit-s5-p2", "#edit-s5-p3", "#edit-s5-p4"].map(sel => cleanName($(sel).value));
      const payload = {
        person1: p[0] || "Vago",
        person2: p[1] || "Vago",
        person3: p[2] || "Vago",
        person4: p[3] || "Vago",
        shift: $("#edit-s5-shift").value,
      };

      update(ref(db, "s5Teams/" + id), payload).then(() => {
        toast("Equipe atualizada!", "ok");
        closeModal();
      });
    }
    
    /* ========================== Settings ========================== */
    function saveSettings(){
      const vals = [$("#al1").value,$("#al2").value,$("#al3").value,$("#al4").value].map(v=>parseInt(v,10));
      const pers = parseInt($("#alP").value,10);
      if (vals.some(v=>!v||v<=0) || !pers || pers<=0){
        return toast("Valores inv√°lidos.", "error");
      }
      for (let i=0;i<vals.length-1;i++){
        if (vals[i] >= vals[i+1]) return toast("Alertas devem ser crescentes.", "error");
      }
      if (vals[vals.length-1] >= pers) return toast("Alarme cont√≠nuo deve ser maior que o 4¬∫ alerta.", "error");
      const payload = {
        alertLevels: vals,
        persistentAlarmMinutes: pers,
        defaultReason: $("#def-reason").value || "Banheiro"
      };
      set(ref(db, "settings"), payload).then(()=>toast("Configura√ß√µes salvas!", "ok"));
    }

    /* ========================== Backup / Reset ========================== */
    async function downloadBackup(){
      const [saidasSnap, s5Snap, confSnap, historicoSnap] = await Promise.all([
        get(ref(db, "saidas")),
        get(ref(db, "s5Teams")),
        get(ref(db, "settings")),
        get(ref(db, "historicoSaidas")), // NOVO
      ]);
      const content = {
        saidas: saidasSnap.val() || {},
        historicoSaidas: historicoSnap.val() || {}, // NOVO
        s5Teams: s5Snap.val() || {},
        settings: confSnap.val() || {},
        exportedAt: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(content, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `backup_gerenciador_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    
    async function uploadBackup(file){
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if (!data || typeof data !== "object") throw new Error("Arquivo inv√°lido.");
        const ok = await confirmBox("Importar backup COMPLETO e substituir dados na nuvem?");
        if (!ok) throw new Error("cancel");
        
        const tasks = [];
        if (data.saidas) tasks.push(set(ref(db, "saidas"), data.saidas));
        if (data.historicoSaidas) tasks.push(set(ref(db, "historicoSaidas"), data.historicoSaidas)); // NOVO
        if (data.s5Teams) tasks.push(set(ref(db, "s5Teams"), data.s5Teams));
        if (data.settings) tasks.push(set(ref(db, "settings"), data.settings));
        
        await Promise.all(tasks);
        toast("Backup importado!", "ok");
      }catch(e){
        if (e.message!=="cancel") toast("Falha ao importar.", "error");
      }
    }
    
    async function resetAll(){
      const ok = await confirmBox("Resetar TUDO (sa√≠das, hist√≥rico, 5S, configura√ß√µes)?");
      if (!ok) return;
      await Promise.all([
        remove(ref(db, "saidas")),
        remove(ref(db, "historicoSaidas")), // NOVO
        remove(ref(db, "s5Teams")),
        remove(ref(db, "settings")),
      ]);
      toast("Tudo resetado.", "ok");
    }

    /* ========================== Clock & alerts ========================== */
    function startClock(){
      if (state.timers.clock) clearInterval(state.timers.clock);
      if (state.timers.alert) clearInterval(state.timers.alert);
      state.timers.alert = null; 

      state.timers.clock = setInterval(()=>{
        const now = Date.now();
        $("#clock").textContent = new Date().toLocaleTimeString("pt-BR", {hour12:false});
        
        let shouldBeep = false;
        const { alertLevels, persistentAlarmMinutes } = state.settings;

        state.requests.forEach(r=>{
          const el = document.querySelector(`#pending-list [data-li-id="${r.id}"]`); 
          const currentVisualLevel = state.alarmLevelsCache[r.id] || 0;
          let newVisualLevel = 0; 

          if (r.status==="pending"){
            const durEl = document.querySelector(`[data-dur="${r.id}-wait"]`);
            if (durEl) durEl.textContent = fmtDur(now - new Date(r.requestTime));
          
          } else if (r.status==="approved"){
            const durEl = document.querySelector(`[data-dur="${r.id}-out"]`);
            if (!r.departureTime) return;
            
            const departureTime = new Date(r.departureTime).getTime();
            const elapsedMs = now - departureTime;
            if (durEl) durEl.textContent = fmtDur(elapsedMs);

            const elapsedMinutes = elapsedMs / 60000;
            
            let alertClass = '';
            if (elapsedMinutes >= alertLevels[0] && elapsedMinutes < alertLevels[1]) {
                alertClass = 'alarm-level-1';
                newVisualLevel = 1;
            }
            else if (elapsedMinutes >= alertLevels[1] && elapsedMinutes < alertLevels[2]) {
                alertClass = 'alarm-level-2';
                newVisualLevel = 2;
            }
            else if (elapsedMinutes >= alertLevels[2] && elapsedMinutes < alertLevels[3]) {
                alertClass = 'alarm-level-3';
                newVisualLevel = 3;
            }
            else if (elapsedMinutes >= alertLevels[3]) { 
                alertClass = 'alarm-level-4';
                newVisualLevel = 4;
            }

            if (el) {
                el.classList.remove('alarm-level-1', 'alarm-level-2', 'alarm-level-3', 'alarm-level-4');
                if(alertClass) el.classList.add(alertClass);
            }
            
            if (newVisualLevel > currentVisualLevel) {
                console.log(`Bipe de Transi√ß√£o para: ${r.userName} (N√≠vel ${newVisualLevel})`);
                shouldBeep = true; 
                state.alarmLevelsCache[r.id] = newVisualLevel; 
            }
            
            if (elapsedMinutes >= persistentAlarmMinutes) {
              if (!state.alarmingStudents.has(r.id)) {
                console.log(`Alarme PERSISTENTE para: ${r.userName}`);
                state.alarmingStudents.add(r.id);
                shouldBeep = true; 
              }
            } else {
              if (state.alarmingStudents.has(r.id)) {
                  state.alarmingStudents.delete(r.id);
              }
            }
          } 
          
          else { 
             if (state.alarmLevelsCache[r.id]) {
                delete state.alarmLevelsCache[r.id];
             }
             if (state.alarmingStudents.has(r.id)) {
                console.log(`Limpando alarme (Loop) para ${r.userName} (Status: ${r.status})`);
                state.alarmingStudents.delete(r.id);
             }
             if (el) {
                el.classList.remove('alarm-level-1', 'alarm-level-2', 'alarm-level-3', 'alarm-level-4');
             }
          }
        }); 

        if (shouldBeep) {
            playBeep();
        }

      }, 1000); 

      state.timers.alert = setInterval(() => {
        if (state.alarmingStudents.size > 0 && state.alarmOn) {
            console.log("Bipe de alarme persistente (Repeti√ß√£o)...");
            playBeep();
        }
      }, 5000); 
    }

    /* ========================== Tabs & Events ========================== */
    function activateTab(id){
      $$(".tab-btn").forEach(b=>b.classList.remove("active"));
      $$("div[id^='tab-']").forEach(c=>c.classList.add("hidden")); 
      
      const $btn = $(`[data-tab="${id}"]`);
      const $tab = $(`#tab-${id}`);
      
      if ($btn) $btn.classList.add("active");
      if ($tab) $tab.classList.remove("hidden");
    }

    function bindEvents(){
      document.body.addEventListener('click', initAudio, { once: true });
      document.body.addEventListener('input', initAudio, { once: true });

      $("#btn-add").addEventListener("click", addStudent);
      
      const pList = $("#pending-list");

      pList.addEventListener("click", (e)=>{
        const btn = e.target.closest("button[data-act]");
        if (!btn) return;
        const act = btn.dataset.act, id = btn.dataset.id;
        if (act==="approve") approve(id);
        if (act==="reject") reject(id);
        if (act==="return") arrived(id);
        if (act==="del-saida") removeReq(id);
        if (act==="edit-saida") openEditSaidaModal(id);
      });

      // Drag-n-Drop (Fila)
      let dragSrcId = null;
      function cleanupDragStyles() {
           $$('#pending-list li').forEach(li => {
              li.classList.remove('drag-over-top', 'drag-over-bottom', 'dragging');
          });
          dragSrcId = null;
      }
      pList.addEventListener("dragstart", (e) => {
          const li = e.target.closest('li[data-drag-id]');
          if (!li || e.target.tagName === 'BUTTON') return e.preventDefault();
          dragSrcId = li.dataset.dragId;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', dragSrcId);
          setTimeout(() => {
              if (dragSrcId) li.classList.add("dragging");
          }, 0);
      });
      pList.addEventListener("dragover", (e) => {
          e.preventDefault();
          if (!dragSrcId) return;
          e.dataTransfer.dropEffect = 'move';
          const destLi = e.target.closest('li[data-drag-id]');
          $$('#pending-list li').forEach(li => {
              li.classList.remove('drag-over-top', 'drag-over-bottom');
          });
          if (!destLi || destLi.dataset.dragId === dragSrcId) return;
          const rect = destLi.getBoundingClientRect();
          const midY = rect.top + rect.height / 2;
          if (e.clientY < midY) {
              destLi.classList.add('drag-over-top');
          } else {
              destLi.classList.add('drag-over-bottom');
          }
      });
      pList.addEventListener("dragleave", (e) => {
          const destLi = e.target.closest('li[data-drag-id]');
          if (destLi) {
              destLi.classList.remove('drag-over-top', 'drag-over-bottom');
          }
      });
      pList.addEventListener("drop", (e) => {
          e.preventDefault();
          if (!dragSrcId) return cleanupDragStyles();
          const destLi = e.target.closest('li[data-drag-id]');
          if (!destLi || destLi.dataset.dragId === dragSrcId) {
              return cleanupDragStyles();
          }
          const srcLi = pList.querySelector(`li[data-drag-id="${dragSrcId}"]`);
          if (!srcLi) return cleanupDragStyles();
          const rect = destLi.getBoundingClientRect();
          const midY = rect.top + rect.height / 2;
          if (e.clientY < midY) {
              pList.insertBefore(srcLi, destLi);
          } else {
              pList.insertBefore(srcLi, destLi.nextSibling);
          }
          updateQueueOrder(); 
          cleanupDragStyles();
      });
      pList.addEventListener("dragend", (e) => {
          cleanupDragStyles();
      });

      $("#history").addEventListener("click", (e)=>{
        const btn = e.target.closest("button[data-act]");
        if (btn){
          e.stopPropagation();
          const act = btn.dataset.act, id = btn.dataset.id;
          if (act==="del-saida") removeReq(id);
          if (act==="edit-saida") openEditSaidaModal(id);
          return;
        }
        
        const hdr = e.target.closest("div[data-day]");
        if(hdr) {
          const list = hdr.nextElementSibling;
          if(list) list.classList.toggle("hidden");
          const caret = hdr.querySelector("span");
          if(caret) caret.classList.toggle("rotate-180");
        }
      });
      
      $("#hist-search").addEventListener("input", renderSaidas);
      
      $("#s5-add").addEventListener("click", addS5Team);

      $("#s5-list").addEventListener("click", (e)=>{
        const btn = e.target.closest("button[data-act]");
        if (!btn) return;
        const act = btn.dataset.act, id = btn.dataset.id;
        if (act==="edit-s5") openEditS5Modal(id);
        if (act==="del-s5") removeS5Team(id);
      });
      
      $("#btn-save-settings").addEventListener("click", saveSettings);

      $("#ddm-header").addEventListener("click", ()=> {
        $("#ddm").classList.toggle("hidden");
        $("#ddm-caret").classList.toggle("rotate-180");
      });
      $("#btn-backup-download").addEventListener("click", downloadBackup);
      $("#file-backup").addEventListener("change", (e)=> e.target.files[0] && uploadBackup(e.target.files[0]));
      $("#btn-reset").addEventListener("click", resetAll);

      $$(".tab-btn").forEach(b=> b.addEventListener("click", ()=> activateTab(b.dataset.tab)));

      $("#alarm-pill").addEventListener("click", () => {
        state.alarmOn = !state.alarmOn;
        const pill = $("#alarm-pill");
        if (state.alarmOn) {
            pill.textContent = "ALARME: LIGADO";
            pill.classList.remove("bg-rose-200", "text-rose-800", "dark:bg-rose-800", "dark:text-rose-200");
            pill.classList.add("bg-emerald-200", "text-emerald-800", "dark:bg-emerald-800", "dark:text-emerald-200");
            toast("Alarmes ligados.", "ok");
        } else {
            pill.textContent = "ALARME: DESLIGADO";
            pill.classList.add("bg-rose-200", "text-rose-800", "dark:bg-rose-800", "dark:text-rose-200");
            pill.classList.remove("bg-emerald-200", "text-emerald-800", "dark:bg-emerald-800", "dark:text-emerald-200");
            toast("Alarmes silenciados.", "info");
        }
      });

      $("#login-btn").addEventListener("click", ()=> {
        initAudio();
        login($("#login-user").value, $("#login-pin").value)
      });
      $("#logout-btn").addEventListener("click", logout);
    }

    /* ========================== Boot ========================== */
    function boot(){
      if (tryAutoLogin()) {
        // Login bem sucedido
      } else {
        showLogin(true);
      }
      
      bindEvents();
      bindRealtime();
      startClock();
      activateTab("saidas");
    }

    // Iniciar a aplica√ß√£o
    boot();
  </script>
</body>
</html>
